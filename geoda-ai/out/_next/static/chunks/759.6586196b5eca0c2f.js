"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[759],{82759:function(e,t,a){a.r(t),a.d(t,{DuckDBTableComponent:function(){return w},processArrowTable:function(){return p}});var n=a(57437),r=a(2265),l=a(16347),o=a(45706),i=a(61152),s=a(2910),u=a(39668),c=a(94241),m=a(89687),d=a(91806);let f=(0,s.pfw)(),y=s.ITH.get(s.m7x);function p(e){let t=[];return e.schema.fields.forEach((e,a)=>{var n;let r=null===(n=e.metadata.get("ARROW:extension:name"))||void 0===n?void 0:n.startsWith("geoarrow");t.push({name:e.name,id:e.name,displayName:e.name,format:"",fieldIdx:a,type:r?c.ALL_FIELD_TYPES.geoarrow:(0,u.arrowDataTypeToFieldType)(e.type),analyzerType:r?o.DATA_TYPES.GEOMETRY:(0,u.arrowDataTypeToAnalyzerDataType)(e.type),valueAccessor:e=>t=>e.valueAt(t.index,a),metadata:e.metadata})}),{fields:t,rows:[],cols:[...Array(e.numCols).keys()].map(t=>e.getChildAt(t)),metadata:e.schema.metadata}}function w(){let e=(0,l.I0)(),t=(0,d.Fg)(),[a,o]=(0,r.useState)(""),u=(0,l.v9)(e=>e.root.file.rawFileData),c=u.name,p=(0,l.v9)(e=>e.keplerGl.kepler_map),w=(0,r.useMemo)(()=>Object.values(p.visState.datasets)[0],[p.visState.datasets]),E=(0,r.useMemo)(()=>Object.keys(p.visState.datasets)[0],[p.visState.datasets]),{fields:T,dataContainer:b,pinnedColumns:x,filteredIndex:h}=w,C=(0,r.useMemo)(()=>{let e={};return h.forEach(t=>{e[t]=!0}),e},[h]),g=(0,r.useMemo)(()=>T.map(e=>e.name),[T]),v=(0,r.useMemo)(()=>T.reduce((e,t)=>{let{name:a,displayName:n,type:r,filterProps:l,format:o,displayFormat:i}=t;return{...e,[a]:{name:n||a,type:r,...o?{format:o}:{},...i?{displayFormat:i}:{},...(null==l?void 0:l.columnStats)?{columnStats:l.columnStats}:{}}}},{}),[T]),S=(0,r.useMemo)(()=>T.reduce((e,a,n)=>({...e,[a.name]:(0,s.pqN)({text:{dataContainer:b,column:a.displayName},colIdx:n,type:a.type,fontSize:t.cellFontSize,font:t.fontFamily,minCellSize:122})}),{}),[T,b,t.cellFontSize,t.fontFamily]),{visStateActions:A}=f(e,{}),{query:k,importArrowFile:D}=(0,m.bW)(),N=async()=>{let t=await k(a);console.log("query result",t),t&&e({type:"SET_FILTER_INDEXES",payload:{dataLabel:c,filteredIndex:t}})};return(0,r.useEffect)(()=>{console.log("useEffect importArrowFile"),D(u),o('select * from "'.concat(c,'" LIMIT 5'))},[u,D,c]),(0,n.jsxs)("div",{className:"item-center flex w-full flex-col p-5",style:{height:"100%",minWidth:"50vw",padding:"20px"},children:[(0,n.jsxs)("div",{className:"flex w-full basis-1/4 flex-col items-center justify-center",children:[(0,n.jsx)("div",{className:"h-20 w-full rounded border-2 border-solid border-rose-800 p-1",children:(0,n.jsx)(i.ZP,{language:"sql",value:a,onChange:e=>{e&&o(e)},options:{minimap:{enabled:!1}}})}),(0,n.jsxs)("div",{className:"m-2 flex w-full flex-row items-start space-x-4",children:[(0,n.jsx)("button",{onClick:N,className:"inline-flex items-center rounded bg-gray-300 px-4 py-2 text-gray-800 hover:bg-gray-400",children:"Query"}),(0,n.jsx)("button",{className:"inline-flex items-center rounded bg-gray-300 px-4 py-2 text-gray-800 hover:bg-gray-400",children:"Reset"})]})]}),(0,n.jsx)(y,{dataId:E,columns:g,colMeta:v,cellSizeCache:S,dataContainer:b,filteredIndex:C,pinnedColumns:x,sortColumn:{},sortTableColumn:A.sortTableColumn,pinTableColumn:A.pinTableColumn,copyTableColumn:A.copyTableColumn,setColumnDisplayFormat:A.setColumnDisplayFormat,theme:t},E)]})}t.default=w},89687:function(e,t,a){a.d(t,{EW:function(){return y},Zi:function(){return f},bW:function(){return p}});var n=a(2265),r=a(36629),l=a(79121),o=a(37037),i=a(41762);let s={mvp:{mainModule:o,mainWorker:new a.U(a(82471)).toString()},eh:{mainModule:i,mainWorker:new a.U(a(37770)).toString()}},u=null,c=null,m=null;async function d(){if(null===u){await new Promise(e=>setTimeout(e,2e3));let e=await l.Dn(s),t=new Worker(e.mainWorker),a=new l.kw;return u=new l.ak(a,t),await u.instantiate(e.mainModule,e.pthreadWorker),u}return null}async function f(e){if(u){if(!m){!c&&e&&(c=e);let t=await u.connect(),a=(await t.query('SUMMARIZE "'.concat(c,'"'))).toArray().map(e=>e.toJSON());await t.close();let n=a.map(e=>Object.values(e).join(",")).join("\n"),r=Object.keys(a[0]).join(",");m="".concat(r,"\n").concat(n)}return m}return""}function y(){return m}function p(){return{query:(0,n.useCallback)(async e=>{var t;if("SELECT"!==(e=e.trim()).substring(0,6).toUpperCase())throw Error("Only SELECT queries are supported");if(!u)throw Error("DuckDB is not initialized");e="SELECT row_index AS selected_index, ".concat(e.substring(6));let a=await u.connect(),n=null===(t=(await a.query(e)).getChildAt(0))||void 0===t?void 0:t.toArray();return await a.close(),n||[]},[]),importArrowFile:(0,n.useCallback)(async e=>{if(u){let t=await u.connect();if(c=e.name,!(await t.query("select * from information_schema.tables")).toArray().map(e=>e.toJSON()).some(e=>e.table_name===c))try{let a=await e.arrayBuffer(),n=(0,r.p)(a);await t.insertArrowTable(n,{name:c}),await t.query('ALTER TABLE "'.concat(c,'" ADD COLUMN row_index INTEGER DEFAULT 0')),await t.query("CREATE SEQUENCE serial"),await t.query('UPDATE "'.concat(c,"\" SET row_index = nextval('serial') - 1"));let l=await f();console.log("summary",l)}catch(e){console.error(e)}await t.close()}},[])}}setTimeout(async()=>{u=await d()},200)}}]);