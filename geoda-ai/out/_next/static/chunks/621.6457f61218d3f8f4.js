"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[621],{24621:function(e,t,a){a.r(t),a.d(t,{NO_MAP_LOADED_MESSAGE:function(){return en},NO_OPENAI_KEY_MESSAGE:function(){return er},default:function(){return ei}});var r,n,i=a(57437),l=a(2265);a(91159);var s=a(26564),o=a(16347),u=a(98149),d=a(98885),c=a(51812),m=a(59611),p=a(12576),h=a(89687),g=a(18985),f=a(3237),y=a(41825),w=a(88096);(r=n||(n={})).SUMMARIZE_DATA="summarizeData",r.QUANTILE_BREAKS="quantileBreaks",r.NATURAL_BREAKS="naturalBreaks",r.KNN_WEIGHT="knnWeight",r.LOCAL_MORAN="univariateLocalMoran",r.HISTOGRAM="histogram",r.BOXPLOT="boxplot";let v={summarizeData:async function(e){let{tableName:t}=e;return{tableName:t,result:await (0,h.Zi)()}},quantileBreaks:async function(e,t){let{k:a,variableName:r}=e,{tableName:n,visState:i}=t;if(!(0,g.nD)(n,r,i))return{result:"".concat(f.Iy," For example, create a quantile map using variable HR60 and 5 quantiles.")};let l=(0,g.aT)(n,r,i.datasets);return l&&0!==l.length?{type:"mapping",name:"Quantile Breaks",result:await (0,u.H)(a,l)}:{result:f.x0}},naturalBreaks:async function(e,t){let{k:a,variableName:r}=e,{tableName:n,visState:i}=t;if(!(0,g.nD)(n,r,i))return{result:"".concat(f.Iy," For example, create a jenks map using variable HR60 and 5 breaks.")};let l=(0,g.aT)(n,r,i.datasets);return l&&0!==l.length?{type:"mapping",name:"Natural Breaks",result:await (0,d.a)(a,l)}:{result:f.x0}},knnWeight:async function(e,t){let{k:a}=e,{tableName:r,visState:n}=t;if(!r)return{result:"Error: table name is empty"};let i=(0,g.Rf)(r,n);if(!i)return{result:"Error: layer is empty"};let l=i.meta.featureTypes,s=i.dataToFeature;if(!s||!l)return{result:"Error: geometries in layer is empty"};let o=await (0,c.V)({k:a,binaryGeometryType:l,binaryGeometries:s});return{type:"weights",name:"KNN",result:{...(0,m.R)(o),id:"w-".concat(a,"-nn"),type:"knn",symmetry:"asymmetric",k:a},data:o}},univariateLocalMoran:async function(e,t){let{variableName:a,weightsID:r,permutations:n=999,significanceThreshold:i=.05}=e,{tableName:l,visState:s,weights:o}=t,u=o.find(e=>e.weightsMeta.id===r);if(0===o.length)return{result:f.Yq};if(u||(u=o[o.length-1]),!l)return{result:"Error: table name is empty"};if(!(0,g.nD)(l,a,s))return{result:"".concat(f.Iy," For example, run local moran analysis using variable HR60 and KNN weights with k=4.")};let d=await (0,g.aT)(l,a,s.datasets);if(!d||0===d.length)return{result:"Error: column data is empty"};let c=await (0,p.v)(d,null==u?void 0:u.weights,n),m=c.pValues.map((e,t)=>e>i?0:c.clusters[t]);return{type:"lisa",name:"Local Moran",result:{significanceThreshold:i,permutations:n,variableName:a,weightsID:r,numberOfHighHighClusters:m.filter(e=>1===e).length,numberOfLowLowClusters:m.filter(e=>2===e).length,numberOfHighLowClusters:m.filter(e=>3===e).length,numberOfLowHighClusters:m.filter(e=>4===e).length,numberOfIsolatedClusters:m.filter(e=>5===e).length,globalMoranI:c.lisaValues.reduce((e,t)=>e+t,0)/c.lisaValues.length},data:c}},histogram:function(e,t){let{k:a,variableName:r}=e,{dataContainer:n}=t,i=(0,g.eR)(r,n);if(!i||0===i.length)return{type:"histogram",result:"".concat(f.x0)};let l=(0,y.g)(i,a),s=l.map(e=>{let{items:t,...a}=e;return a});return{type:"histogram",name:"Histogram",result:{id:Math.random().toString(36).substring(7),variableName:r,numberOfBins:a,histogram:s},data:l}},boxplot:function(e,t){let{variableNames:a,boundIQR:r}=e,{dataContainer:n}=t,i=a.reduce((e,t)=>{let a=(0,g.eR)(t,n);return e[t]=a,e},{});if(!i||0===Object.keys(i).length)return{type:"boxplot",result:"".concat(f.x0)};let l=(0,w.F)({data:i,boundIQR:r||1.5});return{type:"boxplot",name:"Boxplot",result:{id:Math.random().toString(36).substring(7),variables:a,boundIQR:r,boxplot:l.boxData},data:l}}};var x=a(16081);let b=null,S=null,k=null;async function A(e){b||(b=new x.ZP({apiKey:e,dangerouslyAllowBrowser:!0}),S=await b.beta.assistants.retrieve("asst_nowaCi4DNY6SwLJIiLtDOuLG"),k=await b.beta.threads.create())}async function C(e){let{question:t,customFunctions:a,customFunctionContext:r,customMessageCallback:n}=e;if(!b||!k||!S)return[];await b.beta.threads.messages.create(k.id,{role:"user",content:t});let i=await b.beta.threads.runs.create(k.id,{assistant_id:S.id}),l=await b.beta.threads.runs.retrieve(k.id,i.id),s=null;for(;"completed"!==l.status;){if(await new Promise(e=>setTimeout(e,1e3)),"requires_action"===(l=await b.beta.threads.runs.retrieve(k.id,i.id)).status){var o;let e=null===(o=l.required_action)||void 0===o?void 0:o.submit_tool_outputs.tool_calls,t=[];for(let n=0;(null==e?void 0:e.length)&&n<e.length;n++){let i=e[n],l=i.function.name,o=JSON.parse(i.function.arguments);Object.keys(o).map(e=>o[e]);let u=a[l],d=null;if(u&&(d=await u(o,r)).result&&(t.push({tool_call_id:i.id,output:JSON.stringify(d.result)}),s={functionName:l,functionArgs:o,output:d}),!u||!d.result){let e="The function ".concat(l," is not defined. You can contact GeoDa.AI team for assistance.");t.push({tool_call_id:i.id,output:e})}}await b.beta.threads.runs.submitToolOutputs(k.id,i.id,{tool_outputs:t});continue}if(["failed","cancelled","expired"].includes(l.status))break}let u=(await b.beta.threads.messages.list(k.id)).data.filter(e=>e.run_id===i.id&&"assistant"===e.role).pop();if(u){if("text"in u.content[0]){let e=[{message:u.content[0].text.value,sender:"ChatGPT",direction:"incoming",position:"normal"}];if(s){let t=n(s);t&&e.push(t)}return e}}else["failed","cancelled","expired"].includes(l.status);return[]}function j(e){let{functionName:t,functionArgs:a,output:r}=e;return"summarizeData"!==t?{type:"custom",message:"",sender:"GeoDa.AI",direction:"incoming",position:"normal",payload:{type:"custom",functionName:t,functionArgs:a,output:r}}:null}var E=a(81898),T=a(37431),M=a(33679),N=a(8455),I=a.n(N),L=a(2999);let _=e=>{let{fill:t="currentColor",filled:a=!0,size:r=24,height:n=24,width:l=24,...s}=e;return(0,i.jsx)("svg",{width:r||l||24,height:r||n||24,viewBox:"0 0 24 24",fill:a?t:"none",xmlns:"http://www.w3.org/2000/svg",...s,children:(0,i.jsx)("path",{d:"M12.62 20.81c-.34.12-.9.12-1.24 0C8.48 19.82 2 15.69 2 8.69 2 5.6 4.49 3.1 7.56 3.1c1.82 0 3.43.88 4.44 2.24a5.53 5.53 0 0 1 4.44-2.24C19.51 3.1 22 5.6 22 8.69c0 7-6.48 11.13-9.38 12.12Z",stroke:t,strokeWidth:1.5,strokeLinecap:"round",strokeLinejoin:"round"})})};function O(){return(0,i.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:(0,i.jsx)("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M10 0C4.47715 0 0 4.47715 0 10C0 15.5228 4.47715 20 10 20C15.5228 20 20 15.5228 20 10C20 4.47715 15.5228 0 10 0ZM8.75 14.1667L3.33333 8.75L4.58333 7.5L8.75 11.6667L15.4167 5L16.6667 6.25L8.75 14.1667Z",fill:"#00C853"})})}let D=e=>{let{props:t}=e,[a,r]=(0,l.useState)(!1),{output:n}=t,s=(0,o.I0)(),u=n.data,d=n.result;return(0,i.jsx)("div",{className:"w-60",children:(0,i.jsx)(M.A,{radius:"full",className:"mt-2 bg-gradient-to-tr from-pink-500 to-yellow-500 text-white shadow-none",onClick:()=>{s((0,L.GE)({weights:u,weightsMeta:d,isNew:!0})),r(!0)},startContent:a?(0,i.jsx)(O,{}):(0,i.jsx)(_,{}),isDisabled:a,children:(0,i.jsx)(I(),{options:{strings:"Click to Add This Spatial Weights",autoStart:!0,loop:!1,delay:10}})})})};var G=a(94241),F=a(79140),B=a(52295);let P=e=>{let{props:t}=e,a=(0,o.I0)(),[r,n]=(0,l.useState)(!1),s=(0,o.v9)(e=>(0,g.Hs)(e)),u=(0,o.v9)(e=>(0,g.pY)(e)),{output:d}=t,c=d.data,{significanceThreshold:m,variableName:p}=d.result;return(0,i.jsx)("div",{className:"w-60",children:!r&&(0,i.jsx)(M.A,{radius:"full",className:"mt-2 bg-gradient-to-tr from-pink-500 to-yellow-500 text-white shadow-none",onClick:()=>{let e=c.pValues.map((e,t)=>e>m?0:c.clusters[t]),t="lm_".concat(p);if(!u)return;let r=u.dataContainer,i=u.fields.length,l={id:t,name:t,displayName:t,format:"",type:G.ALL_FIELD_TYPES.real,analyzerType:"FLOAT",fieldIdx:i,valueAccessor:e=>r.valueAt(e.index,i)};a((0,F.addTableColumn)(u.id,l,e)),(0,B.KU)({uniqueValues:[0,1,2,3,4,5],hexColors:f.qt,legendLabels:f.Fg,mappingType:"Local Moran",colorFieldName:t,dispatch:a,layer:s}),n(!0)},startContent:(0,i.jsx)(_,{}),children:(0,i.jsx)(I(),{options:{strings:"Click to Create a Local Moran Map",autoStart:!0,loop:!1,delay:10}})})})};var R=a(3629),H=a(92175);let q=e=>{let{props:t}=e,a=(0,o.I0)(),[r,n]=(0,l.useState)(!1),{output:s}=t,{id:u,variableName:d}=s.result,c=s.data;return(0,i.jsxs)("div",{className:"w-full",children:[(0,i.jsx)(H.C,{props:{id:u,type:"histogram",variable:d,data:c}}),!r&&(0,i.jsx)(M.A,{radius:"full",className:"mt-2 w-full bg-gradient-to-tr from-pink-500 to-yellow-500 text-white shadow-none",onClick:()=>{a((0,R.nI)({id:u,type:"histogram",variable:d,data:c,isNew:!0})),n(!0)},startContent:(0,i.jsx)(_,{}),children:(0,i.jsx)(I(),{options:{strings:"Click to Add This Histogram",autoStart:!0,loop:!1,delay:10}})})]})};var U=a(50757);let W=e=>{let{props:t}=e,a=(0,o.I0)(),[r,n]=(0,l.useState)(!1),{output:s}=t,{id:u,variables:d}=s.result,c=s.data;return(0,i.jsxs)("div",{className:"w-full",children:[(0,i.jsx)(U.k,{props:{id:u,type:"boxplot",variables:d,data:c}}),!r&&(0,i.jsx)(M.A,{radius:"full",className:"mt-2 w-full bg-gradient-to-tr from-pink-500 to-yellow-500 text-white shadow-none",onClick:()=>{a((0,R.nI)({id:u,type:"boxplot",variables:d,data:c,isNew:!0})),n(!0)},startContent:(0,i.jsx)(_,{}),children:(0,i.jsx)(I(),{options:{strings:"Click to Add This Box Plot",autoStart:!0,loop:!1,delay:10}})})]})};var Z=a(2336),z=a(2910),K=a(42751),V=a(63923),Y=a(39668);let J=z.ITH.get(z.PZ_),Q={mapControls:Object.keys(K.uiStateUpdaters.DEFAULT_MAP_CONTROLS).reduce((e,t)=>({...e,[t]:{active:!1,show:!1}}),{}),activeSidePanel:null,readonly:!0};function X(e){let{mapIndex:t,mapHeight:a,mapWidth:r,layerId:n}=e,s=(0,o.I0)(),u=(0,o.v9)(e=>{var t,a;return null===(a=e.root.file)||void 0===a?void 0:null===(t=a.rawFileData)||void 0===t?void 0:t.name}),d=(0,o.v9)(e=>e.keplerGl[f.EG]),c=(0,o.v9)(e=>e.root.uiState.theme),m=V.themeLT,{visStateActions:p,mapStateActions:h,uiStateActions:g,providerActions:y,mapStyleActions:w}=(0,z.pfw)()(e=>s((0,F.wrapTo)(G.NO_MAP_ID,e)),{}),v=(0,l.useMemo)(()=>d.visState.layers.map(e=>(u.startsWith(e.config.label),e)),[d.visState.layers,u]),x=(0,l.useMemo)(()=>{let e=v.filter(e=>e.id===n).map(e=>e.id),a=null==e?void 0:e.reduce((e,t)=>({...e,[t]:!0}),{});return Array(t+1).fill(0).map((e,r)=>r===t?{layers:a}:{layers:[]})},[n,t,v]),b={id:f.EG,getState:e=>e.keplerGl[f.EG],initialUiState:Q,mapboxApiAccessToken:"",dispatch:s,visStateActions:p,mapStateActions:h,uiStateActions:g,providerActions:y,mapStyleActions:w,visState:{...null==d?void 0:d.visState,splitMaps:x,layers:null==d?void 0:d.visState.layers.filter(e=>e.id===n).map(e=>(e.updateLayerConfig({isVisible:!0}),e)),layerOrder:[n],layerData:[null==d?void 0:d.visState.layerData[null==d?void 0:d.visState.layers.findIndex(e=>e.id===n)]]},mapState:{...null==d?void 0:d.mapState,isViewportSynced:!1,isZoomLocked:!1},uiState:{...null==d?void 0:d.uiState,...Q},providerState:d.providerState,mapStyle:{...null==d?void 0:d.mapStyle,styleType:G.NO_MAP_ID,bottomMapStyle:null,backgroundColor:(0,Y.hexToRgb)("light"===c?"#FFFFFF":"#000000")}},S=(0,z.r2g)(b,t);return(0,i.jsx)("div",{style:{height:null!=a?a:280,width:null!=r?r:300},className:"rounded bg-white dark:bg-black",children:(0,i.jsx)(Z.ZP,{defaultHeight:280,defaultWidth:300,children:e=>{let{height:a,width:r}=e,n=(0,K.findMapBounds)(S.visState.layers),l=(0,Y.getCenterAndZoomFromBounds)(n,{width:r,height:a}),s={...S.mapState,...l?{latitude:l.center[1],longitude:l.center[0],...Number.isFinite(l.zoom)?{zoom:l.zoom}:{}}:{}};return(0,i.jsx)("div",{style:{height:a,width:r},className:"rounded p-2",children:(0,i.jsx)(z.yW5,{mapState:s,children:(0,i.jsx)(J,{width:r,height:a,primary:!1,index:t,containerId:t,theme:m,...S},t)})})}})})}let $=e=>{let{props:t}=e,[a,r]=(0,l.useState)(!1),{functionArgs:n,output:s}=t,u=(0,o.I0)(),d=(0,o.v9)(e=>(0,g.Hs)(e)),c=(0,o.v9)(e=>e.keplerGl[f.EG].visState.layers),m=(0,l.useMemo)(()=>{if("mapping"===s.type){let e=s.result,{variableName:t}=n;return(0,B.oF)({breaks:e,mappingType:s.name,colorFieldName:t,dispatch:u,layer:d,isPreview:!0}).id}return null},[u,n,d,s.name,s.result,s.type]);return(0,i.jsxs)("div",{className:"w-60",children:[m&&(0,i.jsx)(X,{layerId:m,mapIndex:1,mapWidth:280,mapHeight:180}),(0,i.jsx)(M.A,{radius:"full",className:"mt-2 bg-gradient-to-tr from-pink-500 to-yellow-500 text-white shadow-none",onClick:()=>{if("mapping"===s.type){let e=c.map(e=>e.id).filter(e=>e!==m),t=[m,...e];u((0,F.reorderLayer)(t))}r(!0)},startContent:a?(0,i.jsx)(O,{}):(0,i.jsx)(_,{}),isDisabled:a,children:(0,i.jsx)(I(),{options:{strings:"Click to Add This Map",autoStart:!0,loop:!1,delay:10}})})]})};function ee(e){let{props:t}=e;return void 0!==t.functionName&&(0,i.jsxs)(i.Fragment,{children:["mapping"===t.output.type&&(0,i.jsx)($,{props:t}),"weights"===t.output.type&&(0,i.jsx)(D,{props:t}),"lisa"===t.output.type&&(0,i.jsx)(P,{props:t}),"histogram"===t.output.type&&(0,i.jsx)(q,{props:t}),"boxplot"===t.output.type&&(0,i.jsx)(W,{props:t})]})}var et=a(9448);let ea=e=>{let{openAIKey:t,initOpenAI:a,processMessage:r,getCustomMessageComponent:n}=e,o=(0,s.Z)(),[u,d]=(0,l.useState)([]),c=n&&n();(0,l.useEffect)(()=>{d([{message:o.formatMessage({id:"GeoDa.AI.initialMessage",defaultMessage:"Hello, I'm GeoDa.AI chatbot! Let's do spatial analysis! Ask me anything about your data."}),sentTime:"just now",sender:"ChatGPT",direction:"incoming",position:"first"}]),t&&a(t)},[]);let[m,p]=(0,l.useState)(!1),h=async e=>{let t=[...u,{message:e,direction:"outgoing",sender:"user",position:"normal"}];d(t),p(!0);let a=await r(e);a&&d([...t,...a]),p(!1)};return(0,l.useEffect)(()=>{let e=document.getElementById("chat-message-list");(null==e?void 0:e.firstElementChild)&&(e.firstElementChild.scrollTop=e.firstElementChild.scrollHeight)},[u]),(0,i.jsx)(et.tz,{className:"pl-4",children:(0,i.jsxs)(et.uU,{children:[(0,i.jsx)(et.rN,{id:"chat-message-list",autoScrollToBottom:!0,autoScrollToBottomOnMount:!1,scrollBehavior:"smooth",typingIndicator:m?(0,i.jsx)(et.c2,{content:o.formatMessage({id:"GeoDa.AI.isTyping",defaultMessage:"GeoDa.AI is typing"})}):null,children:u.map((e,t)=>{var a;return"custom"===e.type&&c?(0,i.jsx)(et.v0,{model:{direction:"incoming",type:"custom",position:"normal"},children:(0,i.jsx)(et.v0.CustomContent,{className:"w-[283px]",children:(0,i.jsx)(c,{props:null!==(a=e.payload)&&void 0!==a?a:{}})})},t):(0,i.jsx)(et.v0,{model:e},t)})}),(0,i.jsx)(et.Ru,{placeholder:o.formatMessage({id:"chatGpt.inputPlaceholder",defaultMessage:"Type message here"}),onSend:h,className:"fill-current text-black dark:text-white"})]})})},er="Please config your OpenAI API key in Settings.",en="Please load a map first before chatting.";var ei=()=>{let e=(0,s.Z)(),t=(0,o.v9)(e=>{var t,a;return null===(a=e.root.file)||void 0===a?void 0:null===(t=a.rawFileData)||void 0===t?void 0:t.name}),a=(0,o.v9)(e=>e.root.uiState.openAIKey),{initOpenAI:r,processChatGPTMessage:n}=function(){let e=(0,o.v9)(e=>e.root.file.rawFileData.name),t=(0,o.v9)(e=>e.keplerGl[f.EG].visState),a=(0,o.v9)(e=>e.root.weights),r=(0,o.v9)(t=>(0,g.ir)(e,t.keplerGl[f.EG].visState.datasets));return{initOpenAI:A,processChatGPTMessage:async function(n){return C({question:n,customFunctions:v,customFunctionContext:{tableName:e,visState:t,weights:a,dataContainer:r},customMessageCallback:j})}}}();return(0,i.jsx)(T.c,{title:e.formatMessage({id:"chatGpt.title",defaultMessage:"GeoDa.AI ChatBot"}),description:e.formatMessage({id:"chatGpt.description",defaultMessage:"Powered by OpenAI"}),children:a?t?(0,i.jsx)(ea,{openAIKey:a,initOpenAI:r,processMessage:n,getCustomMessageComponent:()=>ee}):(0,i.jsx)(E.Xr,{message:en,type:"warning"}):(0,i.jsx)(E.Xr,{message:er,type:"warning"})})}},89687:function(e,t,a){a.d(t,{Zi:function(){return m},bW:function(){return p}});var r=a(2265),n=a(79121),i=a(37037),l=a(41762);let s={mvp:{mainModule:i,mainWorker:new a.U(a(82471)).toString()},eh:{mainModule:l,mainWorker:new a.U(a(37770)).toString()}},o=null,u=null,d=null;async function c(){if(null===o){await new Promise(e=>setTimeout(e,2e3));let e=await n.Dn(s),t=new Worker(e.mainWorker),a=new n.kw;return o=new n.ak(a,t),await o.instantiate(e.mainModule,e.pthreadWorker),o}return null}async function m(e){if(o){if(!d){!u&&e&&(u=e);try{let e=await o.connect(),t=(await e.query('SUMMARIZE "'.concat(u,'"'))).toArray().map(e=>e.toJSON());await e.close();let a=t.map(e=>Object.values(e).join(",")).join("\n"),r=Object.keys(t[0]).join(",");d="".concat(r,"\n").concat(a)}catch(e){return"error: can not get summary of the table because table name is not found"}}return d}return"Error: can not get summary of the table because the duckdb is not working properly."}function p(){return{query:(0,r.useCallback)(async e=>{var t;if("SELECT"!==(e=e.trim()).substring(0,6).toUpperCase())throw Error("Only SELECT queries are supported");if(!o)throw Error("DuckDB is not initialized");e="SELECT row_index AS selected_index, ".concat(e.substring(6));let a=await o.connect(),r=null===(t=(await a.query(e)).getChildAt(0))||void 0===t?void 0:t.toArray();return await a.close(),r||[]},[]),importArrowFile:(0,r.useCallback)(async e=>{let{name:t,arrowTable:a}=e;if(o){let e=await o.connect();if(!(await e.query("select * from information_schema.tables")).toArray().map(e=>e.toJSON()).some(e=>e.table_name===t))try{await e.insertArrowTable(a,{name:t}),await e.query('ALTER TABLE "'.concat(t,'" ADD COLUMN row_index INTEGER DEFAULT 0')),await e.query("CREATE SEQUENCE serial"),await e.query('UPDATE "'.concat(t,"\" SET row_index = nextval('serial') - 1")),await m()}catch(e){}await e.close()}},[])}}setTimeout(async()=>{o=await c()},200)}}]);