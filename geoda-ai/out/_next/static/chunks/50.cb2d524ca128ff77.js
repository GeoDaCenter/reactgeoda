"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[50],{89050:function(e,t,a){a.r(t),a.d(t,{default:function(){return j}});var n=a(57437),i=a(2265);a(91159);var s=a(9448),o=a(26564),r=a(16347),l=a(2336),c=a(16081),u=a(89687);let d=null,m=null,h=null,p={localMoran:function(e){return console.log("calling localMoran() with arguments:",e),"local moran"},summarizeData:function(e){return console.log("calling summarizeData() with arguments:",e),(0,u.EW)()}},g={role:"system",content:"Explain things like you're talking to a software professional with 2 years of experience."};function f(){return(0,n.jsxs)("svg",{className:"warning-icon",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"#FFD700",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,n.jsx)("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),(0,n.jsx)("line",{x1:"12",y1:"16",x2:"12",y2:"16"})]})}function w(e){return(0,n.jsxs)("div",{className:"warning-box mb-4 flex flex-row  bg-yellow-50 p-4 text-sm text-yellow-800 dark:bg-gray-800 dark:text-yellow-300",children:[(0,n.jsx)("div",{className:"warning-icon p-1",children:(0,n.jsx)(f,{})}),(0,n.jsx)("div",{className:"warning-message flex-grow p-1",children:e.message})]})}function x(){return(0,n.jsxs)("svg",{className:"gear-icon",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"#FFD700",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,n.jsx)("circle",{cx:"12",cy:"12",r:"3"}),(0,n.jsx)("path",{d:"M19.4 15a8 8 0 01-2.05 2.05l-2.3-1.15a6 6 0 00-1.4-.7l-.7-2.1a6 6 0 000-2.8l.7-2.1a6 6 0 001.4-.7l2.3-1.15A8 8 0 0119.4 9M9 2v.01M3 9h.01"})]})}let y=e=>{let{title:t,description:a,icon:i,children:s}=e;return(0,n.jsxs)("div",{className:"settings-panel",children:[(0,n.jsxs)("div",{className:"modal-header",children:[(0,n.jsxs)("div",{className:"content",children:[null!=i?i:(0,n.jsx)(x,{}),(0,n.jsxs)("div",{className:"text-and-supporting",children:[(0,n.jsx)("div",{className:"text",children:t}),(0,n.jsx)("div",{className:"supporting-text",children:a})]})]}),(0,n.jsx)("div",{className:"padding-bottom"})]}),(0,n.jsx)("div",{className:"form-wrapper text-sm!important",children:s})]})},v=e=>{let{openAIKey:t}=e,a=(0,o.Z)(),{initOpenAI:r,processMessage:f}={initOpenAI:async function(e){d||(d=new c.ZP({apiKey:e,dangerouslyAllowBrowser:!0}),m=await d.beta.assistants.retrieve("asst_nowaCi4DNY6SwLJIiLtDOuLG"),h=await d.beta.threads.create())},processMessageWithFetch:async function(e,t){let a=e.map(e=>({role:"ChatGPT"===e.sender?"assistant":"user",content:e.message})),n={model:"gpt-3.5-turbo",messages:[g,{role:"system",content:"string"==typeof t?t:JSON.stringify(t)},...a]},i=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:"Bearer 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","Content-Type":"application/json"},body:JSON.stringify(n)}),s=await i.json();return(console.log(s),s&&s.choices&&s.choices.length>0)?{message:s.choices[0].message.content,sender:"ChatGPT",direction:"incoming",position:"normal"}:(console.error("The data.choices is undefined or empty."),null)},processMessage:async function(e){if(!d||!h||!m)return null;await d.beta.threads.messages.create(h.id,{role:"user",content:e});let t=await d.beta.threads.runs.create(h.id,{assistant_id:m.id}),a=await d.beta.threads.runs.retrieve(h.id,t.id);for(;"completed"!==a.status;){if(await new Promise(e=>setTimeout(e,1e3)),"requires_action"===(a=await d.beta.threads.runs.retrieve(h.id,t.id)).status){var n;let e=null===(n=a.required_action)||void 0===n?void 0:n.submit_tool_outputs.tool_calls,i=[];for(let t=0;(null==e?void 0:e.length)&&t<e.length;t++){let a=e[t],n=a.function.name;console.log("This question requires us to call a function: ".concat(n));let s=JSON.parse(a.function.arguments),o=Object.keys(s).map(e=>s[e]);console.log("The arguments for this function are: ".concat(o," and ").concat(s));let r=p[n];if(r){let e=r(s);i.push({tool_call_id:a.id,output:e})}}await d.beta.threads.runs.submitToolOutputs(h.id,t.id,{tool_outputs:i});continue}if(["failed","cancelled","expired"].includes(a.status)){console.log("Run status is '".concat(a.status,"'. Unable to complete the request."));break}}let i=(await d.beta.threads.messages.list(h.id)).data.filter(e=>e.run_id===t.id&&"assistant"===e.role).pop();if(i){if("text"in i.content[0]){let e=i.content[0].text.value;return console.log("The assistant responded with: ".concat(e)),{message:e,sender:"ChatGPT",direction:"incoming",position:"normal"}}}else["failed","cancelled","expired"].includes(a.status)||console.log("No response received from the assistant.");return null},uploadSummary:async function(e){if(d&&m&&e){let t=await (0,u.Zi)(e),a=new Blob([t],{type:"text/plain;charset=utf-8"}),n=await d.files.create({purpose:"assistants",file:new File([a],"data_summary_".concat(e,".txt"))}),i=await d.beta.assistants.retrieve(m.id),s=i.file_ids||[];console.log("existingFileIds",s),await d.beta.assistants.update(m.id,{file_ids:[...s,n.id]}),i.file_ids=[...s,n.id],console.log("updatedExistingFileIds",(await d.beta.assistants.retrieve(m.id)).file_ids||[])}}},[w,x]=(0,i.useState)([]);(0,i.useEffect)(()=>{x([{message:a.formatMessage({id:"chatGpt.initialMessage",defaultMessage:"Hello, I'm GeoDa.AI powered by ChatGPT! Let's do spatial analysis! Ask me anything about your data."}),sentTime:"just now",sender:"ChatGPT",direction:"incoming",position:"first"}]),t&&r(t)},[]);let[y,v]=(0,i.useState)(!1),j=async e=>{let t=[...w,{message:e,direction:"outgoing",sender:"user",position:"normal"}];x(t),v(!0);let a=await f(e);a&&x([...t,a]),v(!1)};return(0,n.jsx)(l.ZP,{children:e=>{let{height:t,width:i}=e;return(0,n.jsx)("div",{style:{position:"relative",height:"".concat(t,"px"),width:"".concat(i,"px")},children:(0,n.jsx)(s.tz,{children:(0,n.jsxs)(s.uU,{children:[(0,n.jsx)(s.rN,{autoScrollToBottom:!0,scrollBehavior:"smooth",typingIndicator:y?(0,n.jsx)(s.c2,{content:a.formatMessage({id:"chatGpt.isTyping",defaultMessage:"GeoDa.AI is typing"})}):null,children:w.map((e,t)=>(0,n.jsx)(s.v0,{model:e},t))}),(0,n.jsx)(s.Ru,{placeholder:a.formatMessage({id:"chatGpt.inputPlaceholder",defaultMessage:"Type message here"}),onSend:j})]})})})}})};var j=()=>{let e=(0,o.Z)(),t=(0,r.v9)(e=>{var t,a;return null===(a=e.root.file)||void 0===a?void 0:null===(t=a.rawFileData)||void 0===t?void 0:t.name}),a=(0,r.v9)(e=>e.root.uiState.openAIKey);return(0,n.jsx)(y,{title:e.formatMessage({id:"chatGpt.title",defaultMessage:"GeoDa.AI ChatBot"}),description:e.formatMessage({id:"chatGpt.description",defaultMessage:"Powered by ChatGPT"}),children:a?t?(0,n.jsx)(v,{openAIKey:a}):(0,n.jsx)(w,{message:"Please load a map first before chatting."}):(0,n.jsx)(w,{message:"Please config your OpenAI API key in Settings."})})}},89687:function(e,t,a){a.d(t,{EW:function(){return p},Zi:function(){return h},bW:function(){return g}});var n=a(2265),i=a(36629),s=a(79121),o=a(37037),r=a(41762);let l={mvp:{mainModule:o,mainWorker:new a.U(a(82471)).toString()},eh:{mainModule:r,mainWorker:new a.U(a(37770)).toString()}},c=null,u=null,d=null;async function m(){if(null===c){await new Promise(e=>setTimeout(e,2e3));let e=await s.Dn(l),t=new Worker(e.mainWorker),a=new s.kw;return c=new s.ak(a,t),await c.instantiate(e.mainModule,e.pthreadWorker),c}return null}async function h(e){if(c){if(!d){!u&&e&&(u=e);let t=await c.connect(),a=(await t.query('SUMMARIZE "'.concat(u,'"'))).toArray().map(e=>e.toJSON());await t.close();let n=a.map(e=>Object.values(e).join(",")).join("\n"),i=Object.keys(a[0]).join(",");d="".concat(i,"\n").concat(n)}return d}return""}function p(){return d}function g(){return{query:(0,n.useCallback)(async e=>{var t;if("SELECT"!==(e=e.trim()).substring(0,6).toUpperCase())throw Error("Only SELECT queries are supported");if(!c)throw Error("DuckDB is not initialized");e="SELECT row_index AS selected_index, ".concat(e.substring(6));let a=await c.connect(),n=null===(t=(await a.query(e)).getChildAt(0))||void 0===t?void 0:t.toArray();return await a.close(),n||[]},[]),importArrowFile:(0,n.useCallback)(async e=>{if(c){let t=await c.connect();if(u=e.name,!(await t.query("select * from information_schema.tables")).toArray().map(e=>e.toJSON()).some(e=>e.table_name===u))try{let a=await e.arrayBuffer(),n=(0,i.p)(a);await t.insertArrowTable(n,{name:u}),await t.query('ALTER TABLE "'.concat(u,'" ADD COLUMN row_index INTEGER DEFAULT 0')),await t.query("CREATE SEQUENCE serial"),await t.query('UPDATE "'.concat(u,"\" SET row_index = nextval('serial') - 1"));let s=await h();console.log("summary",s)}catch(e){console.error(e)}await t.close()}},[])}}setTimeout(async()=>{c=await m()},200)}}]);