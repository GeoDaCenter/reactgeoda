!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="5de63242-9ecb-48b0-88b7-6dbc37adb51f",e._sentryDebugIdIdentifier="sentry-dbid-5de63242-9ecb-48b0-88b7-6dbc37adb51f")}catch(e){}}();"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[51],{53058:function(e,t,a){a.r(t),a.d(t,{default:function(){return el}});var l=a(57437),s=a(2265),n=a(26564),r=a(16347),i=a(19153),d=a(87884),o=a(14265),c=a(90666),u=a(37431),m=a(81898),h=a(46778),x=a(64509),f=a(74335),g=a(85598),p=a(33679),v=a(63406),j=a(50622),b=a(61152);a(2223);var y=a(66262),S=a(21996);function w(e){let{datasetId:t,setDatasetId:a,keplerDataset:n,tableName:i}=e,d=(0,r.I0)(),{query:u}=(0,h.bW)(),m=(0,r.v9)(e=>e.root.uiState.theme),w=(0,r.v9)(e=>e.root.uiState.table.queryCode),C=function(e){try{return(0,j.parseSQL)(e)}catch(e){return{combinator:"and",rules:[]}}}(w||"select * from ".concat(i)),N=(0,s.useMemo)(()=>(0,x.kQ)(n),[n]),[k,I]=(0,s.useState)(w||""),[R,L]=(0,s.useState)(C),[E,V]=(0,s.useState)(!0),D=async()=>{I(""),L({combinator:"and",rules:[]}),d((0,y.S$)("")),await _()},_=async()=>{let e=await u(i,k);e&&d((0,y.PC)({sourceId:"table-query",dataId:t,filteredIndex:e}))};return(0,l.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,l.jsx)(S.N,{datasetId:t,setDatasetId:a}),(0,l.jsxs)("div",{className:"m-2 flex flex-col gap-4 text-xs",children:[(0,l.jsx)(f.K,{defaultSelected:!0,size:"sm",checked:E,onValueChange:e=>{V(e)},children:"Use Query Builder"}),E&&(0,l.jsx)(v.ZP,{query:R,onQueryChange:e=>{L(e),I((0,v.x9)(e,{format:"sql",fallbackExpression:"()"}))},fields:N,controlClassnames:{queryBuilder:"queryBuilder-branches"}})]}),(0,l.jsxs)(o.w,{children:[(0,l.jsx)(g.u,{children:(0,l.jsxs)("p",{className:"ml-2 text-xs text-blue-700 drop-shadow-sm",children:["SELECT * FROM ",i," WHERE"]})}),(0,l.jsx)(c.G,{children:(0,l.jsx)("div",{className:"h-40 w-full",children:(0,l.jsx)(b.ZP,{language:"sql",value:k,onChange:e=>{e&&(I(e),d((0,y.S$)(e)))},options:{minimap:{enabled:!1}},theme:"dark"===m?"vs-dark":"vs-light"})})})]}),(0,l.jsxs)("div",{className:"m-2 flex w-full flex-row items-start space-x-4",children:[(0,l.jsx)(p.A,{onClick:_,size:"sm",color:"danger",className:"bg-rose-900",children:"Query"}),(0,l.jsx)(p.A,{onClick:D,size:"sm",color:"default",children:"Reset"})]})]})}var C=a(51866),N=a(4319),k=a(96986),I=a(23064),R=a(53254);let L=[{label:"Uniform Random",value:"uniform_random",description:"Random uniform dist on unit interval"},{label:"Normal Random",value:"normal_random",description:"Random Gaussian dist with mean and standard deviation"},{label:"Enumerate",value:"enumerate",description:"enumerate as 1, 2, 3, ..."}];function E(e){let{numberOfRows:t,columnType:a,setValues:n}=e,[r,i]=(0,s.useState)(""),[d,o]=(0,s.useState)(""),[c,u]=(0,s.useState)(0),[m,h]=(0,s.useState)(1),f=(0,s.useMemo)(()=>"real"===a?L.slice(0,2):"integer"===a?[L[2]]:[],[a]);return(0,l.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,l.jsx)(R.d,{allowsCustomValue:!0,label:"",placeholder:"Enter default value",defaultItems:L,onValueChange:e=>{i(e),"integer"===a?n(parseInt(e)):"real"===a?n(parseFloat(e)):n(e)},onSelectionChange:e=>{o(e),"uniform_random"===e?n((0,x.x8)(t)):"normal_random"===e&&n((0,x.VX)(t,c,m))},"aria-label":"Default Value",children:f.map(e=>(0,l.jsx)(k.R,{value:e.value,textValue:e.label,children:(0,l.jsxs)("div",{className:"flex flex-col",children:[(0,l.jsx)("span",{className:"text-small",children:e.label}),(0,l.jsx)("span",{className:"text-tiny text-default-400",children:e.description})]})},e.value))}),"normal_random"===d&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(C.Y,{type:"text",label:"Mean Value",placeholder:"",onValueChange:e=>{let a=0;try{a=parseFloat(e)}catch(e){a=0}u(a),n((0,x.VX)(t,a,m))},size:"sm",value:"".concat(c)}),(0,l.jsx)(C.Y,{type:"text",label:"Standard Deviation",placeholder:"",onValueChange:e=>{let a=0;try{a=parseFloat(e)}catch(e){a=0}h(a),n((0,x.VX)(t,a,m))},size:"sm",value:"".concat(m)})]})]})}var V=a(25276),D=a(7111),_=a(35550),T=a(61128),A=a(1201),M=a(10149),W=a(20103),z=a(91979),P=a(44733),q=a.n(P);let F=(0,s.forwardRef)((e,t)=>{let{initContent:a,onChange:n,theme:r,suggestKeys:i,language:d,height:o}=e,[c,u]=(0,s.useState)(a||"");c!==a&&a&&u(a);let m=(0,s.useRef)(null);return(0,s.useImperativeHandle)(t,()=>({insertText(e){var t;null===(t=m.current)||void 0===t||t.trigger("keyboard","type",{text:e})}})),(0,l.jsx)(b.ZP,{defaultLanguage:d||"sql",value:c,onChange:(e,t)=>{var a,l;e&&u(e),null==m||null===(l=m.current)||void 0===l||null===(a=l.getAction("editor.action.formatDocument"))||void 0===a||a.run(),n(e,t)},onMount:(e,t)=>{m.current=e;let a=i.map(e=>({label:e,insertText:e}));t.languages.register({id:"geoda"}),t.languages.setMonarchTokensProvider("geoda",{keywords:i,tokenizer:{root:[[/([a-zA-Z_$][\w$]*)((\s*))?/,{cases:{"$1@keywords":"keyword"}}],[/[-+*/]/,"operator"],[/[()]/,"delimiter"]]}}),t.editor.defineTheme("geoda-theme",{base:"vs",inherit:!0,colors:{},rules:[{token:"keyword",foreground:"#FF6600",fontStyle:"bold"},{token:"operator",foreground:"#ff0000"},{token:"delimiter",foreground:"#009966"}]}),t.languages.registerCompletionItemProvider("*",{provideCompletionItems:(e,l)=>{let s=e.getWordUntilPosition(l),n={startLineNumber:l.lineNumber,startColumn:s.startColumn,endLineNumber:l.lineNumber,endColumn:l.column};return{suggestions:a.map(e=>({label:e.label,kind:t.languages.CompletionItemKind.Field,insertText:e.insertText,range:n}))}}})},options:{minimap:{enabled:!1},fixedOverflowWidgets:!0},theme:"dark"===r?"vs-dark":"vs-light",height:o||240,width:"100%"})});F.displayName="SQLEditor";var G=a(43688);let O=e=>(0,l.jsxs)("svg",{"aria-hidden":"true",fill:"none",focusable:"false",height:"1em",role:"presentation",viewBox:"0 0 24 24",width:"1em",...e,children:[(0,l.jsx)("path",{d:"M11.5 21C16.7467 21 21 16.7467 21 11.5C21 6.25329 16.7467 2 11.5 2C6.25329 2 2 6.25329 2 11.5C2 16.7467 6.25329 21 11.5 21Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2"}),(0,l.jsx)("path",{d:"M22 22L20 20",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2"})]}),Q=[...G.bx,...G.B$,...G.hD,...G.zv,...G.U5];function K(e){let{tableName:t,keplerDataset:a,setValues:n}=e,[i,d]=(0,s.useState)(""),[u,m]=(0,s.useState)(Q),x=(0,r.v9)(e=>e.root.uiState.theme),{queryValues:f}=(0,h.bW)(),g=(0,s.useRef)(null),p=(0,s.useMemo)(()=>{let e=[...G.B$,...G.U5].map(e=>e.name.replace(/\(.*\)/g,"")).join("|");return RegExp("(".concat(e,")\\(([^)]+)\\)"),"g")},[]);(0,s.useEffect)(()=>{(async()=>{let e=0===i.length?"0":i.replace(p,'(select $1($2) from "'.concat(t,'")')),a="SELECT ".concat(e,' FROM "').concat(t,'";');n(Array.from(await f(a)))})()},[p,i,f,n,t]);let v=[...(null==a?void 0:a.fields.map(e=>e.name))||[],...Q.map(e=>e.name.replace(/\(.*\)/g,""))];return(0,l.jsxs)("div",{className:"flex flex-col gap-2 text-tiny",children:[(0,l.jsx)("p",{children:"Use SQL operations and functions to create new variable, e.g. (HR60 + HR70) / (PO60 + PO70)"}),(0,l.jsx)(o.w,{children:(0,l.jsx)(c.G,{children:(0,l.jsx)("div",{className:"relative h-20 w-full",children:(0,l.jsx)(F,{initContent:i,onChange:e=>{e&&d(e)},theme:x,suggestKeys:v,language:"geoda",height:100,ref:g})})})}),(0,l.jsxs)("div",{className:"flex w-full flex-col gap-1 p-1",children:[(0,l.jsx)(C.Y,{label:"",placeholder:"Type to search avaiable duckdb SQL function...",startContent:(0,l.jsx)(O,{className:"pointer-events-none mb-0.5 flex-shrink-0 text-black/50 text-slate-400 dark:text-white/90"}),size:"sm",onValueChange:e=>{m(q().filter(e,Q,{extract:e=>e.name}).map(e=>e.original))}}),(0,l.jsx)("div",{className:"w-full",children:(0,l.jsx)(D.o,{className:"h-[100px] w-full p-1",size:10,children:(0,l.jsxs)(_.b,{hideHeader:!0,"aria-label":"Duckdb function",removeWrapper:!0,isStriped:!0,isCompact:!0,radius:"none",selectionMode:"single",onRowAction:e=>{let t=u[e];g&&g.current&&g.current.insertText(t.name)},children:[(0,l.jsxs)(T.J,{children:[(0,l.jsx)(A.j,{width:20,maxWidth:20,children:"NAME"}),(0,l.jsx)(A.j,{children:"DESCRIPTION"})]}),(0,l.jsx)(M.y,{children:u.map((e,t)=>(0,l.jsxs)(W.g,{children:[(0,l.jsx)(z.X,{className:"text-tiny text-default-500",children:e.name}),(0,l.jsx)(z.X,{className:"text-tiny text-default-500",children:e.description})]},t))})]})})})]})]})}var Y=a(71888),$=a(29424),B=a(83073),H=a(23604);function U(e){var t;let{keplerDataset:a,setValues:n}=e,i=(0,r.v9)(e=>e.root.weights),[d,o]=(0,s.useState)(null),[c,u]=(0,s.useState)(null==i?void 0:null===(t=i[0])||void 0===t?void 0:t.weights),m=(e,t)=>{e&&t&&n(function(e,t){let a=!(arguments.length>2)||void 0===arguments[2]||arguments[2],l=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,n=e.length,r=void 0===l,i=Array(n).fill(0);for(let d=0;d<n;d++){let n=0,o=0,c=!1,u=t[d];for(let t=0;t<u.length;t++){if(d===u[t]){c=!0;continue}r?(n+=e[u[t]],o+=1):(n+=e[u[t]]*l[d][t],o+=l[d][t])}r?(s&&(n+=e[d],o+=1),a&&(n=o>0?n/o:0)):(a&&(n=o>0?n/o:0),s&&(c?n+=e[d]*l[d][u.length]:n+=e[d])),i[d]=n}return i}(e,t))};return(0,l.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,l.jsx)($.W3,{setVariable:e=>{let t=(0,H.T7)(e,a);o(t),c&&m(t,c)}}),(0,l.jsx)(B.a5,{weights:i,onSelectWeights:e=>{let t=i.find(t=>t.weightsMeta.id===e);t&&(u(t.weights),d&&m(d,t.weights))}})]})}var X=a(37087);function Z(e){var t;let{keplerDataset:a,onValuesChange:n}=e,i=(0,r.v9)(e=>e.root.weights),[d,o]=(0,s.useState)(X.G9.RawRates),[c,u]=(0,s.useState)(null==i?void 0:null===(t=i[0])||void 0===t?void 0:t.weights),[m,h]=(0,s.useState)(null),[x,f]=(0,s.useState)(null),[g,p]=(0,s.useState)(void 0),[v,j]=(0,s.useState)(void 0),b=(e,t,a,l,s)=>{t&&l&&(!d.startsWith("Spatial")||s)&&n((0,X.zl)({eventValues:t,baseValues:l,method:d,neighbors:s}),"".concat(d,"_").concat(e,"_").concat(a).replace(/\s/g,"_"))};return(0,l.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,l.jsx)(N.g,{label:"Method",size:"sm",onSelectionChange:e=>{o(e.currentKey),m&&x&&c&&b(g,m,v,x,c)},defaultSelectedKeys:[Object.values(X.G9)[0]],children:Object.values(X.G9).map(e=>(0,l.jsx)(k.R,{value:e,children:e},e))}),(0,l.jsx)($.W3,{defaultVariable:g,setVariable:e=>{p(e);let t=(0,H.T7)(e,a);h(t),x&&(!d.startsWith("Spatial")||c)&&b(e,t,v,x,c)},label:"Event Variable",size:"sm"}),(0,l.jsx)($.W3,{defaultVariable:v,setVariable:e=>{j(e);let t=(0,H.T7)(e,a);f(t),m&&(!d.startsWith("Spatial")||c)&&b(g,m,e,t,c)},label:"Base Variable",size:"sm"}),d.startsWith("Spatial")&&(0,l.jsx)(B.a5,{weights:i,onSelectWeights:e=>{let t=i.find(t=>t.weightsMeta.id===e);t&&(u(t.weights),m&&x&&b(g,m,v,x,t.weights))}})]})}var J=a(44702),ee=a(32303);function et(e){let{datasetId:t,setDatasetId:a,keplerDataset:n,tableName:u}=e,[m,f]=(0,s.useState)(""),[p,v]=(0,s.useState)(I.ALL_FIELD_TYPES.real),[j,b]=(0,s.useState)(null),[y,w]=(0,s.useState)("preview-table"),{addColumn:R,addColumnWithValues:L}=(0,h.bW)(),D=(0,r.I0)(),_=(0,s.useRef)(null),T=(0,r.v9)(e=>e.root.uiState.theme),A=(null==n?void 0:n.dataContainer.numRows())||0,M=[...(null==n?void 0:n.fields.map(e=>e.name))||[],...Y.nn],W=(0,x.rH)({tableName:u,columnName:m,columnType:p,values:j}),[z,P]=(0,s.useState)(W);z!==W&&P(W);let q=(null==n?void 0:n.fields.find(e=>e.name===m))!==void 0,[G,O]=(0,s.useState)(q),Q=t&&t.length>0&&(0,x.kx)(m)&&(0,x.vS)(p);return(0,l.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,l.jsx)(S.N,{datasetId:t,setDatasetId:a}),(0,l.jsx)(C.Y,{type:"text",label:"Column Name",placeholder:"Enter column name",onValueChange:e=>{""===m?P((0,x.rH)({tableName:u,columnName:e,columnType:p,values:j})):P(z.replace(m,e)),f(e),O((null==n?void 0:n.fields.find(t=>t.name===e))!==void 0)},isInvalid:""===m||G,errorMessage:G?"* column name already exists":""}),(0,l.jsxs)(N.g,{label:"Column Type",placeholder:"Select data type",onSelectionChange:e=>{e instanceof Set&&v(e.values().next().value)},size:"sm",className:"text-xs",defaultSelectedKeys:[I.ALL_FIELD_TYPES.real],children:[(0,l.jsx)(k.R,{value:I.ALL_FIELD_TYPES.string,children:"String"},"string"),(0,l.jsx)(k.R,{value:I.ALL_FIELD_TYPES.integer,children:"Integer"},"integer"),(0,l.jsx)(k.R,{value:I.ALL_FIELD_TYPES.real,children:"Real"},"real")]}),(0,l.jsxs)(o.w,{children:[(0,l.jsx)(g.u,{children:(0,l.jsx)("p",{className:"text-tiny",children:"Column Value"})}),(0,l.jsx)(c.G,{children:(0,l.jsxs)(i.n,{"aria-label":"Select Value",size:"sm",variant:"solid",children:[(0,l.jsx)(d.r,{title:"Default Value",children:(0,l.jsx)(E,{numberOfRows:A,columnType:p,setValues:b})},"default-value"),(0,l.jsx)(d.r,{title:"Variable",children:(0,l.jsx)(K,{tableName:u,keplerDataset:n,setValues:b})},"variable"),(0,l.jsx)(d.r,{title:"Spatial Lag",children:(0,l.jsx)(U,{tableName:u,keplerDataset:n,setValues:b})},"spatial-lag"),(0,l.jsx)(d.r,{title:"Rates",children:(0,l.jsx)(Z,{tableName:u,keplerDataset:n,onValuesChange:e=>{b(e)}})},"rates")]})})]}),(0,l.jsx)(o.w,{className:"mt-2",children:(0,l.jsx)(c.G,{children:(0,l.jsxs)(i.n,{"aria-label":"preview-and-sql",size:"sm",selectedKey:y,onSelectionChange:e=>{w(e)},children:[(0,l.jsx)(d.r,{title:"Column Preview",children:(0,l.jsx)(V.A,{fieldName:m,fieldType:p,columnData:j,numberOfRows:A})},"preview-table"),(0,l.jsx)(d.r,{title:"SQL Preview",children:(0,l.jsx)("div",{className:"h-40 w-full",children:(0,l.jsx)(F,{initContent:z,onChange:e=>{e&&P(e)},theme:T,suggestKeys:M,ref:_})})},"preview-sql")]})})}),(0,l.jsx)(J.X,{onClick:()=>{if(Array.isArray(j)){let e=j.some(e=>"string"==typeof e);L({tableName:u,columnName:m,columnValues:j,columnType:e?"VARCHAR":"NUMERIC"})}else R(z);if(n){let{newField:e,values:t}=(0,x.J8)({dataset:n,newFieldName:m,fieldType:p,columnData:j});D((0,ee.addTableColumn)(n.id,e,t))}f("")},isDisabled:!Q,children:"Add Column"})]})}var ea=a(7528),el=function(){let e=(0,n.Z)(),[t,a]=(0,s.useState)("table-query"),h=(0,r.v9)(ea.dS),[x,f]=(0,s.useState)(null==h?void 0:h.id),g=null==h?void 0:h.label;return(0,l.jsx)(u.c,{title:e.formatMessage({id:"table.title",defaultMessage:"Table"}),description:e.formatMessage({id:"table.description",defaultMessage:"Query and edit the table data."}),children:g&&x?(0,l.jsx)("div",{className:"h-full overflow-y-auto  p-1",children:(0,l.jsxs)(i.n,{"aria-label":"Options",variant:"solid",color:"danger",classNames:{},size:"md",selectedKey:t,onSelectionChange:e=>{"table-query"===e?a("table-query"):a("table-edit")},children:[(0,l.jsx)(d.r,{title:(0,l.jsx)("div",{className:"flex items-center space-x-2",children:(0,l.jsx)("span",{children:"Query"})}),children:(0,l.jsx)(o.w,{children:(0,l.jsx)(c.G,{children:(0,l.jsx)(w,{datasetId:x,setDatasetId:f,keplerDataset:h,tableName:g})})})},"table-query"),(0,l.jsx)(d.r,{title:(0,l.jsx)("div",{className:"flex items-center space-x-2",children:(0,l.jsx)("span",{children:"Add Column"})}),children:(0,l.jsx)(o.w,{children:(0,l.jsx)(c.G,{children:(0,l.jsx)(et,{datasetId:x,setDatasetId:f,keplerDataset:h,tableName:g})})})},"table-edit")]})}):(0,l.jsx)(m.Xr,{message:"Please load a map first before querying and editing data.",type:m.Bc.WARNING})})}}}]);