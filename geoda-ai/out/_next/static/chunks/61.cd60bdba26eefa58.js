"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[61],{87061:function(e,t,a){a.r(t),a.d(t,{default:function(){return Q}});var i,r,n=a(57437),s=a(2265);a(91159);var l=a(9448),o=a(26564),u=a(16347),d=a(16081),c=a(89687),m=a(81179),p=a(48892),g=a(8754),h=a(40448),f=a(71188),y=a(18985),w=a(3237),v=a(41825);(i=r||(r={})).SUMMARIZE_DATA="summarizeData",i.QUANTILE_BREAKS="quantileBreaks",i.NATURAL_BREAKS="naturalBreaks",i.KNN_WEIGHT="knnWeight",i.LOCAL_MORAN="univariateLocalMoran",i.HISTOGRAM="histogram";let x={summarizeData:async function(e){let{tableName:t}=e;return console.log("calling summarizeData() with arguments:",t),{tableName:t,result:await (0,c.Zi)()}},quantileBreaks:async function(e,t){let{k:a,variableName:i}=e,{tableName:r,visState:n}=t;if(!(0,y.nD)(r,i,n))return{result:"".concat(w.Iy," For example, create a quantile map using variable HR60 and 5 quantiles.")};let s=(0,y.aT)(r,i,n.datasets);return s&&0!==s.length?{type:"mapping",name:"Quantile Breaks",result:await (0,m.H)(a,s)}:{result:w.x0}},naturalBreaks:async function(e,t){let{k:a,variableName:i}=e,{tableName:r,visState:n}=t;if(!(0,y.nD)(r,i,n))return{result:"".concat(w.Iy," For example, create a jenks map using variable HR60 and 5 breaks.")};let s=(0,y.aT)(r,i,n.datasets);return s&&0!==s.length?{type:"mapping",name:"Natural Breaks",result:await (0,p.a)(a,s)}:{result:w.x0}},knnWeight:async function(e,t){let{k:a}=e,{tableName:i,visState:r}=t;if(!i)return{result:"Error: table name is empty"};let n=(0,y.Rf)(i,r);if(!n)return{result:"Error: layer is empty"};let s=n.meta.featureTypes,l=n.dataToFeature;if(!l||!s)return{result:"Error: geometries in layer is empty"};let o=await (0,g.V)({k:a,binaryGeometryType:s,binaryGeometries:l});return{type:"weights",name:"KNN",result:{...(0,h.R)(o),id:"w-".concat(a,"-nn"),type:"knn",symmetry:"asymmetric",k:a},data:o}},univariateLocalMoran:async function(e,t){let{variableName:a,weightsID:i,permutations:r=999,significanceThreshold:n=.05}=e,{tableName:s,visState:l,weights:o}=t,u=o.find(e=>e.weightsMeta.id===i);if(0===o.length)return{result:w.Yq};if(u||(u=o[o.length-1]),!s)return{result:"Error: table name is empty"};if(!(0,y.nD)(s,a,l))return{result:"".concat(w.Iy," For example, run local moran analysis using variable HR60 and KNN weights with k=4.")};let d=await (0,y.aT)(s,a,l.datasets);if(!d||0===d.length)return{result:"Error: column data is empty"};let c=await (0,f.v)(d,null==u?void 0:u.weights,r),m=c.pValues.map((e,t)=>e>n?0:c.clusters[t]);return{type:"lisa",name:"Local Moran",result:{significanceThreshold:n,permutations:r,variableName:a,weightsID:i,numberOfHighHighClusters:m.filter(e=>1===e).length,numberOfLowLowClusters:m.filter(e=>2===e).length,numberOfHighLowClusters:m.filter(e=>3===e).length,numberOfLowHighClusters:m.filter(e=>4===e).length,numberOfIsolatedClusters:m.filter(e=>5===e).length,globalMoranI:c.lisaValues.reduce((e,t)=>e+t,0)/c.lisaValues.length},data:c}},histogram:function(e,t){let{k:a,variableName:i}=e,{dataContainer:r}=t,n=(0,y.eR)(i,r);if(!n||0===n.length)return{type:"histogram",result:"".concat(w.x0)};let s=(0,v.g)(n,a),l=s.map(e=>{let{items:t,...a}=e;return a});return{type:"histogram",name:"Histogram",result:{id:Math.random().toString(36).substring(7),variableName:i,numberOfBins:a,histogram:l},data:s}}},b=null,S=null,k=null;var A=a(81898),j=a(37431),C=a(33679),T=a(8455),E=a.n(T),I=a(2999);let N=e=>{let{fill:t="currentColor",filled:a=!0,size:i=24,height:r=24,width:s=24,...l}=e;return(0,n.jsx)("svg",{width:i||s||24,height:i||r||24,viewBox:"0 0 24 24",fill:a?t:"none",xmlns:"http://www.w3.org/2000/svg",...l,children:(0,n.jsx)("path",{d:"M12.62 20.81c-.34.12-.9.12-1.24 0C8.48 19.82 2 15.69 2 8.69 2 5.6 4.49 3.1 7.56 3.1c1.82 0 3.43.88 4.44 2.24a5.53 5.53 0 0 1 4.44-2.24C19.51 3.1 22 5.6 22 8.69c0 7-6.48 11.13-9.38 12.12Z",stroke:t,strokeWidth:1.5,strokeLinecap:"round",strokeLinejoin:"round"})})};function M(){return(0,n.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:(0,n.jsx)("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M10 0C4.47715 0 0 4.47715 0 10C0 15.5228 4.47715 20 10 20C15.5228 20 20 15.5228 20 10C20 4.47715 15.5228 0 10 0ZM8.75 14.1667L3.33333 8.75L4.58333 7.5L8.75 11.6667L15.4167 5L16.6667 6.25L8.75 14.1667Z",fill:"#00C853"})})}let _=e=>{let{props:t}=e,[a,i]=(0,s.useState)(!1),{output:r}=t,l=(0,u.I0)(),o=r.data,d=r.result;return(0,n.jsx)("div",{className:"w-60",children:(0,n.jsx)(C.A,{radius:"full",className:"mt-2 bg-gradient-to-tr from-pink-500 to-yellow-500 text-white shadow-none",onClick:()=>{l((0,I.GE)({weights:o,weightsMeta:d,isNew:!0})),i(!0)},startContent:a?(0,n.jsx)(M,{}):(0,n.jsx)(N,{}),isDisabled:a,children:(0,n.jsx)(E(),{options:{strings:"Click to Add This Spatial Weights",autoStart:!0,loop:!1,delay:10}})})})};var L=a(94241),D=a(79140),O=a(52295);let F=e=>{let{props:t}=e,a=(0,u.I0)(),[i,r]=(0,s.useState)(!1),l=(0,u.v9)(e=>(0,y.Hs)(e)),o=(0,u.v9)(e=>(0,y.pY)(e)),{output:d}=t,c=d.data,{significanceThreshold:m,variableName:p}=d.result;return(0,n.jsx)("div",{className:"w-60",children:!i&&(0,n.jsx)(C.A,{radius:"full",className:"mt-2 bg-gradient-to-tr from-pink-500 to-yellow-500 text-white shadow-none",onClick:()=>{let e=c.pValues.map((e,t)=>e>m?0:c.clusters[t]),t="lm_".concat(p);if(!o){console.error("Dataset not found");return}let i=o.dataContainer,n=o.fields.length,s={id:t,name:t,displayName:t,format:"",type:L.ALL_FIELD_TYPES.real,analyzerType:"FLOAT",fieldIdx:n,valueAccessor:e=>i.valueAt(e.index,n)};a((0,D.addTableColumn)(o.id,s,e)),(0,O.KU)({uniqueValues:[0,1,2,3,4,5],hexColors:w.qt,legendLabels:w.Fg,mappingType:"Local Moran",colorFieldName:t,dispatch:a,layer:l}),r(!0)},startContent:(0,n.jsx)(N,{}),children:(0,n.jsx)(E(),{options:{strings:"Click to Create a Local Moran Map",autoStart:!0,loop:!1,delay:10}})})})};var G=a(3629),B=a(92175);let q=e=>{let{props:t}=e,a=(0,u.I0)(),[i,r]=(0,s.useState)(!1),{output:l}=t,{id:o,variableName:d}=l.result,c=l.data;return(0,n.jsxs)("div",{className:"w-full",children:[(0,n.jsx)(B.C,{props:{id:o,type:"histogram",variable:d,data:c}}),!i&&(0,n.jsx)(C.A,{radius:"full",className:"mt-2 w-full bg-gradient-to-tr from-pink-500 to-yellow-500 text-white shadow-none",onClick:()=>{a((0,G.nI)({id:o,type:"histogram",variable:d,data:c,isNew:!0})),r(!0)},startContent:(0,n.jsx)(N,{}),children:(0,n.jsx)(E(),{options:{strings:"Click to Add This Histogram",autoStart:!0,loop:!1,delay:10}})})]})};var R=a(2336),H=a(2910),P=a(42751),U=a(63923),W=a(39668);let Z=H.ITH.get(H.PZ_),z={mapControls:Object.keys(P.uiStateUpdaters.DEFAULT_MAP_CONTROLS).reduce((e,t)=>({...e,[t]:{active:!1,show:!1}}),{}),activeSidePanel:null,readonly:!0};function K(e){let{mapIndex:t,mapHeight:a,mapWidth:i,layerId:r}=e,l=(0,u.I0)(),o=(0,u.v9)(e=>{var t,a;return null===(a=e.root.file)||void 0===a?void 0:null===(t=a.rawFileData)||void 0===t?void 0:t.name}),d=(0,u.v9)(e=>e.keplerGl[w.EG]),c=(0,u.v9)(e=>e.root.uiState.theme),m=U.themeLT,{visStateActions:p,mapStateActions:g,uiStateActions:h,providerActions:f,mapStyleActions:y}=(0,H.pfw)()(e=>l((0,D.wrapTo)(L.NO_MAP_ID,e)),{}),v=(0,s.useMemo)(()=>d.visState.layers.map(e=>(o.startsWith(e.config.label),e)),[d.visState.layers,o]),x=(0,s.useMemo)(()=>{let e=v.filter(e=>e.id===r).map(e=>e.id),a=null==e?void 0:e.reduce((e,t)=>({...e,[t]:!0}),{});return Array(t+1).fill(0).map((e,i)=>i===t?{layers:a}:{layers:[]})},[r,t,v]),b={id:w.EG,getState:e=>e.keplerGl[w.EG],initialUiState:z,mapboxApiAccessToken:"",dispatch:l,visStateActions:p,mapStateActions:g,uiStateActions:h,providerActions:f,mapStyleActions:y,visState:{...null==d?void 0:d.visState,splitMaps:x,layers:null==d?void 0:d.visState.layers.filter(e=>e.id===r).map(e=>(e.updateLayerConfig({isVisible:!0}),e)),layerOrder:[r],layerData:[null==d?void 0:d.visState.layerData[null==d?void 0:d.visState.layers.findIndex(e=>e.id===r)]]},mapState:{...null==d?void 0:d.mapState,isViewportSynced:!1,isZoomLocked:!1},uiState:{...null==d?void 0:d.uiState,...z},providerState:d.providerState,mapStyle:{...null==d?void 0:d.mapStyle,styleType:L.NO_MAP_ID,bottomMapStyle:null,backgroundColor:(0,W.hexToRgb)("light"===c?"#FFFFFF":"#000000")}},S=(0,H.r2g)(b,t);return(0,n.jsx)("div",{style:{height:null!=a?a:280,width:null!=i?i:300},className:"rounded bg-white dark:bg-black",children:(0,n.jsx)(R.ZP,{defaultHeight:280,defaultWidth:300,children:e=>{let{height:a,width:i}=e,r=(0,P.findMapBounds)(S.visState.layers),s=(0,W.getCenterAndZoomFromBounds)(r,{width:i,height:a}),l={...S.mapState,...s?{latitude:s.center[1],longitude:s.center[0],...Number.isFinite(s.zoom)?{zoom:s.zoom}:{}}:{}};return(0,n.jsx)("div",{style:{height:a,width:i},className:"rounded p-2",children:(0,n.jsx)(H.yW5,{mapState:l,children:(0,n.jsx)(Z,{width:i,height:a,primary:!1,index:t,containerId:t,theme:m,...S},t)})})}})})}let V=e=>{let{props:t}=e,[a,i]=(0,s.useState)(!1),{functionArgs:r,output:l}=t,o=(0,u.I0)(),d=(0,u.v9)(e=>(0,y.Hs)(e)),c=(0,u.v9)(e=>e.keplerGl[w.EG].visState.layers),m=(0,s.useMemo)(()=>{if("mapping"===l.type){let e=l.result,{variableName:t}=r;return(0,O.oF)({breaks:e,mappingType:l.name,colorFieldName:t,dispatch:o,layer:d,isPreview:!0}).id}return null},[o,r,d,l.name,l.result,l.type]);return(0,n.jsxs)("div",{className:"w-60",children:[m&&(0,n.jsx)(K,{layerId:m,mapIndex:1,mapWidth:280,mapHeight:180}),(0,n.jsx)(C.A,{radius:"full",className:"mt-2 bg-gradient-to-tr from-pink-500 to-yellow-500 text-white shadow-none",onClick:()=>{if("mapping"===l.type){let e=c.map(e=>e.id).filter(e=>e!==m),t=[m,...e];o((0,D.reorderLayer)(t))}i(!0)},startContent:a?(0,n.jsx)(M,{}):(0,n.jsx)(N,{}),isDisabled:a,children:(0,n.jsx)(E(),{options:{strings:"Click to Add This Map",autoStart:!0,loop:!1,delay:10}})})]})};function J(e){let{props:t}=e;return void 0!==t.functionName&&(0,n.jsxs)(n.Fragment,{children:["mapping"===t.output.type&&(0,n.jsx)(V,{props:t}),"weights"===t.output.type&&(0,n.jsx)(_,{props:t}),"lisa"===t.output.type&&(0,n.jsx)(F,{props:t}),"histogram"===t.output.type&&(0,n.jsx)(q,{props:t})]})}let Y=e=>{let{openAIKey:t}=e,a=(0,o.Z)(),{initOpenAI:i,processMessage:r}=function(){let e=(0,u.v9)(e=>e.root.file.rawFileData.name),t=(0,u.v9)(e=>e.keplerGl[w.EG].visState),a=(0,u.v9)(e=>e.root.weights),i=(0,u.v9)(t=>(0,y.ir)(e,t.keplerGl[w.EG].visState.datasets));return{initOpenAI:async function(e){b||(b=new d.ZP({apiKey:e,dangerouslyAllowBrowser:!0}),S=await b.beta.assistants.retrieve("asst_nowaCi4DNY6SwLJIiLtDOuLG"),k=await b.beta.threads.create())},processMessage:async function(r){if(!b||!k||!S)return null;await b.beta.threads.messages.create(k.id,{role:"user",content:r});let n=await b.beta.threads.runs.create(k.id,{assistant_id:S.id}),s=await b.beta.threads.runs.retrieve(k.id,n.id),l=null;for(;"completed"!==s.status;){if(await new Promise(e=>setTimeout(e,1e3)),"requires_action"===(s=await b.beta.threads.runs.retrieve(k.id,n.id)).status){var o;let r=null===(o=s.required_action)||void 0===o?void 0:o.submit_tool_outputs.tool_calls,u=[];for(let n=0;(null==r?void 0:r.length)&&n<r.length;n++){let s=r[n],o=s.function.name;console.log("This question requires us to call a function: ".concat(o));let d=JSON.parse(s.function.arguments),c=Object.keys(d).map(e=>d[e]);console.log("The arguments for this function are: ".concat(c," and ").concat(d));let m=x[o],p=null;if(m&&(p=await m(d,{tableName:e,visState:t,weights:a,dataContainer:i})).result&&(u.push({tool_call_id:s.id,output:JSON.stringify(p.result)}),l={functionName:o,functionArgs:d,output:p}),!m||!p.result){let e="The function ".concat(o," is not defined. You can contact GeoDa.AI team for assistance.");console.error(e),u.push({tool_call_id:s.id,output:e})}}await b.beta.threads.runs.submitToolOutputs(k.id,n.id,{tool_outputs:u});continue}if(["failed","cancelled","expired"].includes(s.status)){console.log("Run status is '".concat(s.status,"'. Unable to complete the request."));break}}let u=(await b.beta.threads.messages.list(k.id)).data.filter(e=>e.run_id===n.id&&"assistant"===e.role).pop();if(u){if("text"in u.content[0]){let e=u.content[0].text.value;console.log("The assistant responded with: ".concat(e));let t=[{message:e,sender:"ChatGPT",direction:"incoming",position:"normal"}];if(l){let e=function(e){let{functionName:t,functionArgs:a,output:i}=e;return"summarizeData"!==t?{type:"custom",message:"",sender:"GeoDa.AI",direction:"incoming",position:"normal",payload:{type:"custom",functionName:t,functionArgs:a,output:i}}:null}(l);e&&t.push(e)}return t}}else["failed","cancelled","expired"].includes(s.status)||console.log("No response received from the assistant.");return null},uploadSummary:async function(e){if(b&&S&&e){let t=await (0,c.Zi)(e),a=new Blob([t],{type:"text/plain;charset=utf-8"}),i=await b.files.create({purpose:"assistants",file:new File([a],"data_summary_".concat(e,".txt"))}),r=await b.beta.assistants.retrieve(S.id),n=r.file_ids||[];console.log("existingFileIds",n),await b.beta.assistants.update(S.id,{file_ids:[...n,i.id]}),r.file_ids=[...n,i.id],console.log("updatedExistingFileIds",(await b.beta.assistants.retrieve(S.id)).file_ids||[])}}}}(),[m,p]=(0,s.useState)([]);(0,s.useEffect)(()=>{p([{message:a.formatMessage({id:"GeoDa.AI.initialMessage",defaultMessage:"Hello, I'm GeoDa.AI chatbot! Let's do spatial analysis! Ask me anything about your data."}),sentTime:"just now",sender:"ChatGPT",direction:"incoming",position:"first"}]),t&&i(t)},[]);let[g,h]=(0,s.useState)(!1),f=async e=>{let t=[...m,{message:e,direction:"outgoing",sender:"user",position:"normal"}];p(t),h(!0);let a=await r(e);a&&p([...t,...a]),h(!1)};return(0,s.useEffect)(()=>{let e=document.getElementById("chat-message-list");(null==e?void 0:e.firstElementChild)&&(e.firstElementChild.scrollTop=e.firstElementChild.scrollHeight)},[m]),(0,n.jsx)(l.tz,{className:"pl-4",children:(0,n.jsxs)(l.uU,{children:[(0,n.jsx)(l.rN,{id:"chat-message-list",autoScrollToBottom:!0,autoScrollToBottomOnMount:!1,scrollBehavior:"smooth",typingIndicator:g?(0,n.jsx)(l.c2,{content:a.formatMessage({id:"GeoDa.AI.isTyping",defaultMessage:"GeoDa.AI is typing"})}):null,children:m.map((e,t)=>{var a;return"custom"===e.type?(0,n.jsx)(l.v0,{model:{direction:"incoming",type:"custom",position:"normal"},children:(0,n.jsx)(l.v0.CustomContent,{className:"w-[283px]",children:(0,n.jsx)(J,{props:null!==(a=e.payload)&&void 0!==a?a:{}})})},t):(0,n.jsx)(l.v0,{model:e},t)})}),(0,n.jsx)(l.Ru,{placeholder:a.formatMessage({id:"chatGpt.inputPlaceholder",defaultMessage:"Type message here"}),onSend:f,className:"fill-current text-black dark:text-white"})]})})};var Q=()=>{let e=(0,o.Z)(),t=(0,u.v9)(e=>{var t,a;return null===(a=e.root.file)||void 0===a?void 0:null===(t=a.rawFileData)||void 0===t?void 0:t.name}),a=(0,u.v9)(e=>e.root.uiState.openAIKey);return(0,n.jsx)(j.c,{title:e.formatMessage({id:"chatGpt.title",defaultMessage:"GeoDa.AI ChatBot"}),description:e.formatMessage({id:"chatGpt.description",defaultMessage:"Powered by OpenAI"}),children:a?t?(0,n.jsx)(Y,{openAIKey:a}):(0,n.jsx)(A.Xr,{message:"Please load a map first before chatting.",type:"warning"}):(0,n.jsx)(A.Xr,{message:"Please config your OpenAI API key in Settings.",type:"warning"})})}},89687:function(e,t,a){a.d(t,{Zi:function(){return p},bW:function(){return g}});var i=a(2265),r=a(36629),n=a(79121),s=a(37037),l=a(41762);let o={mvp:{mainModule:s,mainWorker:new a.U(a(82471)).toString()},eh:{mainModule:l,mainWorker:new a.U(a(37770)).toString()}},u=null,d=null,c=null;async function m(){if(null===u){await new Promise(e=>setTimeout(e,2e3));let e=await n.Dn(o),t=new Worker(e.mainWorker),a=new n.kw;return u=new n.ak(a,t),await u.instantiate(e.mainModule,e.pthreadWorker),u}return null}async function p(e){if(u){if(!c){!d&&e&&(d=e);try{let e=await u.connect(),t=(await e.query('SUMMARIZE "'.concat(d,'"'))).toArray().map(e=>e.toJSON());await e.close();let a=t.map(e=>Object.values(e).join(",")).join("\n"),i=Object.keys(t[0]).join(",");c="".concat(i,"\n").concat(a)}catch(e){return console.error(e),"error: can not get summary of the table because table name is not found"}}return c}return"Error: can not get summary of the table because the duckdb is not working properly."}function g(){return{query:(0,i.useCallback)(async e=>{var t;if("SELECT"!==(e=e.trim()).substring(0,6).toUpperCase())throw Error("Only SELECT queries are supported");if(!u)throw Error("DuckDB is not initialized");e="SELECT row_index AS selected_index, ".concat(e.substring(6));let a=await u.connect(),i=null===(t=(await a.query(e)).getChildAt(0))||void 0===t?void 0:t.toArray();return await a.close(),i||[]},[]),importArrowFile:(0,i.useCallback)(async e=>{if(u){let t=await u.connect();if(d=e.name,!(await t.query("select * from information_schema.tables")).toArray().map(e=>e.toJSON()).some(e=>e.table_name===d))try{let a=await e.arrayBuffer(),i=(0,r.p)(a);await t.insertArrowTable(i,{name:d}),await t.query('ALTER TABLE "'.concat(d,'" ADD COLUMN row_index INTEGER DEFAULT 0')),await t.query("CREATE SEQUENCE serial"),await t.query('UPDATE "'.concat(d,"\" SET row_index = nextval('serial') - 1"));let n=await p();console.log("summary",n)}catch(e){console.error(e)}await t.close()}},[])}}setTimeout(async()=>{u=await m()},200)}}]);