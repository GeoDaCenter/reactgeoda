"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[759],{82759:function(e,t,a){a.r(t),a.d(t,{DuckDBTableComponent:function(){return w},processArrowTable:function(){return p}});var n=a(57437),r=a(2265),o=a(16347),l=a(45706),i=a(61152),s=a(2910),c=a(39668),u=a(94241),m=a(89687),d=a(91806);let y=(0,s.pfw)(),f=s.ITH.get(s.m7x);function p(e){let t=[];return e.schema.fields.forEach((e,a)=>{var n;let r=null===(n=e.metadata.get("ARROW:extension:name"))||void 0===n?void 0:n.startsWith("geoarrow");t.push({name:e.name,id:e.name,displayName:e.name,format:"",fieldIdx:a,type:r?u.ALL_FIELD_TYPES.geoarrow:(0,c.arrowDataTypeToFieldType)(e.type),analyzerType:r?l.DATA_TYPES.GEOMETRY:(0,c.arrowDataTypeToAnalyzerDataType)(e.type),valueAccessor:e=>t=>e.valueAt(t.index,a),metadata:e.metadata})}),{fields:t,rows:[],cols:[...Array(e.numCols).keys()].map(t=>e.getChildAt(t)),metadata:e.schema.metadata}}function w(){let e=(0,o.I0)(),t=(0,d.Fg)(),[a,l]=(0,r.useState)(""),c=(0,o.v9)(e=>e.root.file.rawFileData),u=c.name,p=(0,o.v9)(e=>e.keplerGl.kepler_map),w=(0,r.useMemo)(()=>Object.values(p.visState.datasets)[0],[p.visState.datasets]),E=(0,r.useMemo)(()=>Object.keys(p.visState.datasets)[0],[p.visState.datasets]),{fields:T,dataContainer:b,pinnedColumns:x,filteredIndex:h}=w,C=(0,r.useMemo)(()=>{let e={};return h.forEach(t=>{e[t]=!0}),e},[h]),g=(0,r.useMemo)(()=>T.map(e=>e.name),[T]),v=(0,r.useMemo)(()=>T.reduce((e,t)=>{let{name:a,displayName:n,type:r,filterProps:o,format:l,displayFormat:i}=t;return{...e,[a]:{name:n||a,type:r,...l?{format:l}:{},...i?{displayFormat:i}:{},...(null==o?void 0:o.columnStats)?{columnStats:o.columnStats}:{}}}},{}),[T]),S=(0,r.useMemo)(()=>T.reduce((e,a,n)=>({...e,[a.name]:(0,s.pqN)({text:{dataContainer:b,column:a.displayName},colIdx:n,type:a.type,fontSize:t.cellFontSize,font:t.fontFamily,minCellSize:122})}),{}),[T,b,t.cellFontSize,t.fontFamily]),{visStateActions:A}=y(e,{}),{query:k,importArrowFile:D}=(0,m.bW)(),N=async()=>{let t=await k(a);console.log("query result",t),t&&e({type:"SET_FILTER_INDEXES",payload:{dataLabel:u,filteredIndex:t}})};return(0,r.useEffect)(()=>{console.log("useEffect importArrowFile"),D(c),l('select * from "'.concat(u,'" LIMIT 5'))},[c,D,u]),(0,n.jsxs)("div",{className:"item-center flex w-full flex-col p-5",style:{height:"100%",minWidth:"50vw",padding:"20px"},children:[(0,n.jsxs)("div",{className:"flex w-full basis-1/4 flex-col items-center justify-center",children:[(0,n.jsx)("div",{className:"h-20 w-full rounded border-2 border-solid border-rose-800 p-1",children:(0,n.jsx)(i.ZP,{language:"sql",value:a,onChange:e=>{e&&l(e)},options:{minimap:{enabled:!1}}})}),(0,n.jsxs)("div",{className:"m-2 flex w-full flex-row items-start space-x-4",children:[(0,n.jsx)("button",{onClick:N,className:"inline-flex items-center rounded bg-gray-300 px-4 py-2 text-gray-800 hover:bg-gray-400",children:"Query"}),(0,n.jsx)("button",{className:"inline-flex items-center rounded bg-gray-300 px-4 py-2 text-gray-800 hover:bg-gray-400",children:"Reset"})]})]}),(0,n.jsx)(f,{dataId:E,columns:g,colMeta:v,cellSizeCache:S,dataContainer:b,filteredIndex:C,pinnedColumns:x,sortColumn:{},sortTableColumn:A.sortTableColumn,pinTableColumn:A.pinTableColumn,copyTableColumn:A.copyTableColumn,setColumnDisplayFormat:A.setColumnDisplayFormat,theme:t},E)]})}t.default=w},89687:function(e,t,a){a.d(t,{EW:function(){return f},Zi:function(){return y},bW:function(){return w},eR:function(){return p}});var n=a(2265),r=a(36629),o=a(79121),l=a(37037),i=a(41762);let s={mvp:{mainModule:l,mainWorker:new a.U(a(82471)).toString()},eh:{mainModule:i,mainWorker:new a.U(a(37770)).toString()}},c=null,u=null,m=null;async function d(){if(null===c){await new Promise(e=>setTimeout(e,2e3));let e=await o.Dn(s),t=new Worker(e.mainWorker),a=new o.kw;return c=new o.ak(a,t),await c.instantiate(e.mainModule,e.pthreadWorker),c}return null}async function y(e){if(c){if(!m){!u&&e&&(u=e);let t=await c.connect(),a=(await t.query('SUMMARIZE "'.concat(u,'"'))).toArray().map(e=>e.toJSON());await t.close();let n=a.map(e=>Object.values(e).join(",")).join("\n"),r=Object.keys(a[0]).join(",");m="".concat(r,"\n").concat(n)}return m}return""}function f(){return m}async function p(e){if(c){let t=await c.connect(),a=(await t.query('SELECT "'.concat(e,'" FROM "').concat(u,'"'))).toArray().map(e=>e.toArray()[0]);return await t.close(),a}return[]}function w(){return{query:(0,n.useCallback)(async e=>{var t;if("SELECT"!==(e=e.trim()).substring(0,6).toUpperCase())throw Error("Only SELECT queries are supported");if(!c)throw Error("DuckDB is not initialized");e="SELECT row_index AS selected_index, ".concat(e.substring(6));let a=await c.connect(),n=null===(t=(await a.query(e)).getChildAt(0))||void 0===t?void 0:t.toArray();return await a.close(),n||[]},[]),importArrowFile:(0,n.useCallback)(async e=>{if(c){let t=await c.connect();if(u=e.name,!(await t.query("select * from information_schema.tables")).toArray().map(e=>e.toJSON()).some(e=>e.table_name===u))try{let a=await e.arrayBuffer(),n=(0,r.p)(a);await t.insertArrowTable(n,{name:u}),await t.query('ALTER TABLE "'.concat(u,'" ADD COLUMN row_index INTEGER DEFAULT 0')),await t.query("CREATE SEQUENCE serial"),await t.query('UPDATE "'.concat(u,"\" SET row_index = nextval('serial') - 1"));let o=await y();console.log("summary",o)}catch(e){console.error(e)}await t.close()}},[])}}setTimeout(async()=>{c=await d()},200)}}]);