"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[393],{34393:function(e,t,a){a.r(t),a.d(t,{default:function(){return R}});var n,r,i=a(57437),s=a(2265);a(91159);var l=a(9448),o=a(26564),u=a(16347),c=a(2336),d=a(16081),m=a(89687),p=a(81179),f=a(48892),g=a(8754),h=a(40448),w=a(71188),y=a(18985),v=a(3237);(n=r||(r={})).SUMMARIZE_DATA="summarizeData",n.QUANTILE_BREAKS="quantileBreaks",n.NATURAL_BREAKS="naturalBreaks",n.KNN_WEIGHT="knnWeight",n.LOCAL_MORAN="univariateLocalMoran";let x={summarizeData:async function(e){let{tableName:t}=e;return console.log("calling summarizeData() with arguments:",t),{tableName:t,result:await (0,m.Zi)()}},quantileBreaks:async function(e,t){let{k:a,variableName:n}=e,{tableName:r,visState:i}=t;if(!(0,y.nD)(r,n,i))return{result:"".concat(v.Iy," For example, create a quantile map using variable HR60 and 5 quantiles.")};let s=(0,y.aT)(r,n,i);return s&&0!==s.length?{type:"mapping",name:"Quantile Breaks",result:await (0,p.H)(a,s)}:{result:v.x0}},naturalBreaks:async function(e,t){let{k:a,variableName:n}=e,{tableName:r,visState:i}=t;if(!(0,y.nD)(r,n,i))return{result:"".concat(v.Iy," For example, create a jenks map using variable HR60 and 5 breaks.")};let s=(0,y.aT)(r,n,i);return s&&0!==s.length?{type:"mapping",name:"Natural Breaks",result:await (0,f.a)(a,s)}:{result:v.x0}},knnWeight:async function(e,t){let{k:a}=e,{tableName:n,visState:r}=t;if(!n)return{result:"Error: table name is empty"};let i=(0,y.Rf)(n,r);if(!i)return{result:"Error: layer is empty"};let s=i.meta.featureTypes,l=i.dataToFeature;if(!l||!s)return{result:"Error: geometries in layer is empty"};let o=await (0,g.V)({k:a,binaryGeometryType:s,binaryGeometries:l});return{type:"weights",name:"KNN",result:{...(0,h.R)(o),id:"w-".concat(a,"-nn"),type:"knn",symmetry:"asymmetric",k:a},data:o}},univariateLocalMoran:async function(e,t){let{variableName:a,weightsID:n,permutations:r=999,significanceThreshold:i=.05}=e,{tableName:s,visState:l,weights:o}=t,u=o.find(e=>e.weightsMeta.id===n);if(0===o.length)return{result:v.Yq};if(u||(u=o[o.length-1]),!s)return{result:"Error: table name is empty"};if(!(0,y.nD)(s,a,l))return{result:"".concat(v.Iy," For example, run local moran analysis using variable HR60 and KNN weights with k=4.")};let c=await (0,y.aT)(s,a,l);if(!c||0===c.length)return{result:"Error: column data is empty"};let d=await (0,w.v)(c,null==u?void 0:u.weights,r),m=d.pValues.map((e,t)=>e>i?0:d.clusters[t]);return{type:"lisa",name:"Local Moran",result:{significanceThreshold:i,permutations:r,variableName:a,weightsID:n,numberOfHighHighClusters:m.filter(e=>1===e).length,numberOfLowLowClusters:m.filter(e=>2===e).length,numberOfHighLowClusters:m.filter(e=>3===e).length,numberOfLowHighClusters:m.filter(e=>4===e).length,numberOfIsolatedClusters:m.filter(e=>5===e).length,globalMoranI:d.lisaValues.reduce((e,t)=>e+t,0)/d.lisaValues.length},data:d}}},b=null,A=null,k=null;var T=a(81898),E=a(37431),C=a(33679),_=a(8455),j=a.n(_),N=a(52295),S=a(2999);let L=e=>{let{fill:t="currentColor",filled:a=!0,size:n=24,height:r=24,width:s=24,...l}=e;return(0,i.jsx)("svg",{width:n||s||24,height:n||r||24,viewBox:"0 0 24 24",fill:a?t:"none",xmlns:"http://www.w3.org/2000/svg",...l,children:(0,i.jsx)("path",{d:"M12.62 20.81c-.34.12-.9.12-1.24 0C8.48 19.82 2 15.69 2 8.69 2 5.6 4.49 3.1 7.56 3.1c1.82 0 3.43.88 4.44 2.24a5.53 5.53 0 0 1 4.44-2.24C19.51 3.1 22 5.6 22 8.69c0 7-6.48 11.13-9.38 12.12Z",stroke:t,strokeWidth:1.5,strokeLinecap:"round",strokeLinejoin:"round"})})},M=e=>{let{props:t}=e,[a,n]=(0,s.useState)(!1),{key:r,output:l,dispatch:o}=t,u=l.data,c=l.result;return(0,i.jsx)("div",{className:"w-60",children:!a&&(0,i.jsx)(C.A,{radius:"full",className:"mt-2 bg-gradient-to-tr from-pink-500 to-yellow-500 text-white shadow-none",onClick:()=>{o((0,S.GE)({weights:u,weightsMeta:c,isNew:!0})),n(!0)},startContent:(0,i.jsx)(L,{}),children:(0,i.jsx)(j(),{options:{strings:"Click to Add This Spatial Weights",autoStart:!0,loop:!1,delay:10}})},r)})};var I=a(94241),D=a(79140);let O=e=>{let{props:t}=e,[a,n]=(0,s.useState)(!1),{key:r,output:l,dispatch:o,geodaState:u}=t,c=l.data,{significanceThreshold:d,variableName:m}=l.result;return(0,i.jsx)("div",{className:"w-60",children:!a&&(0,i.jsx)(C.A,{radius:"full",className:"mt-2 bg-gradient-to-tr from-pink-500 to-yellow-500 text-white shadow-none",onClick:()=>{var e,t;let a=c.pValues.map((e,t)=>e>d?0:c.clusters[t]),r="lm_".concat(m),i=null===(t=u.root.file)||void 0===t?void 0:null===(e=t.rawFileData)||void 0===e?void 0:e.name,s=Object.values(u.keplerGl[v.EG].visState.datasets).find(e=>e.label===i);if(!s){console.error("Dataset not found");return}let l=s.dataContainer,p=s.fields.length,f={id:r,name:r,displayName:r,format:"",type:I.ALL_FIELD_TYPES.real,analyzerType:"FLOAT",fieldIdx:p,valueAccessor:e=>l.valueAt(e.index,p)};o((0,D.addTableColumn)(s.id,f,a)),(0,N.KU)({uniqueValues:[0,1,2,3,4,5],hexColors:v.qt,legendLabels:v.Fg,mappingType:"Local Moran",colorFieldName:r,dispatch:o,geodaState:u}),n(!0)},startContent:(0,i.jsx)(L,{}),children:(0,i.jsx)(j(),{options:{strings:"Click to Create a Local Moran Map",autoStart:!0,loop:!1,delay:10}})},r)})};function G(e){let{props:t}=e,[a,n]=(0,s.useState)(!1),{key:r,functionArgs:l,output:o,dispatch:u,geodaState:c}=t,{createCustomScaleMap:d}=(0,N.M8)();return(0,i.jsxs)(i.Fragment,{children:["mapping"===o.type&&!a&&(0,i.jsx)(C.A,{radius:"full",className:"mt-2 bg-gradient-to-tr from-pink-500 to-yellow-500 text-white shadow-none",onClick:()=>{if("mapping"===o.type){let e=o.result,{variableName:t}=l;d({breaks:e,mappingType:o.name,colorFieldName:t,dispatch:u,geodaState:c})}n(!0)},children:(0,i.jsx)(j(),{options:{strings:"Click to Create a ".concat(o.name," Map"),autoStart:!0,loop:!1,delay:10}})},r),"weights"===o.type&&(0,i.jsx)(M,{props:t}),"lisa"===o.type&&(0,i.jsx)(O,{props:t})]})}let q=e=>{let{openAIKey:t}=e,a=(0,o.Z)(),n=(0,u.I0)(),p=(0,u.v9)(e=>e),{initOpenAI:f,processMessage:g}=function(){let e=(0,u.v9)(e=>e.root.file.rawFileData.name),t=(0,u.v9)(e=>e.keplerGl[v.EG].visState),a=(0,u.v9)(e=>e.root.weights);return{initOpenAI:async function(e){b||(b=new d.ZP({apiKey:e,dangerouslyAllowBrowser:!0}),A=await b.beta.assistants.retrieve("asst_nowaCi4DNY6SwLJIiLtDOuLG"),k=await b.beta.threads.create())},processMessage:async function(n){if(!b||!k||!A)return null;await b.beta.threads.messages.create(k.id,{role:"user",content:n});let r=await b.beta.threads.runs.create(k.id,{assistant_id:A.id}),i=await b.beta.threads.runs.retrieve(k.id,r.id),s=null;for(;"completed"!==i.status;){if(await new Promise(e=>setTimeout(e,1e3)),"requires_action"===(i=await b.beta.threads.runs.retrieve(k.id,r.id)).status){var l;let n=null===(l=i.required_action)||void 0===l?void 0:l.submit_tool_outputs.tool_calls,o=[];for(let r=0;(null==n?void 0:n.length)&&r<n.length;r++){let i=n[r],l=i.function.name;console.log("This question requires us to call a function: ".concat(l));let u=JSON.parse(i.function.arguments),c=Object.keys(u).map(e=>u[e]);console.log("The arguments for this function are: ".concat(c," and ").concat(u));let d=x[l],m=null;if(d&&(m=await d(u,{tableName:e,visState:t,weights:a})).result&&(o.push({tool_call_id:i.id,output:JSON.stringify(m.result)}),s={functionName:l,functionArgs:u,output:m}),!d||!m.result){let e="The function ".concat(l," is not defined. You can contact GeoDa.AI team for assistance.");console.error(e),o.push({tool_call_id:i.id,output:e})}}await b.beta.threads.runs.submitToolOutputs(k.id,r.id,{tool_outputs:o});continue}if(["failed","cancelled","expired"].includes(i.status)){console.log("Run status is '".concat(i.status,"'. Unable to complete the request."));break}}let o=(await b.beta.threads.messages.list(k.id)).data.filter(e=>e.run_id===r.id&&"assistant"===e.role).pop();if(o){if("text"in o.content[0]){let e=o.content[0].text.value;return console.log("The assistant responded with: ".concat(e)),[{message:e,sender:"ChatGPT",direction:"incoming",position:"normal"},...s?[function(e){let{functionName:t,functionArgs:a,output:n}=e;return{type:"custom",message:"",sender:"GeoDa.AI",direction:"incoming",position:"normal",payload:{type:"custom",functionName:t,functionArgs:a,output:n}}}(s)]:[]]}}else["failed","cancelled","expired"].includes(i.status)||console.log("No response received from the assistant.");return null},uploadSummary:async function(e){if(b&&A&&e){let t=await (0,m.Zi)(e),a=new Blob([t],{type:"text/plain;charset=utf-8"}),n=await b.files.create({purpose:"assistants",file:new File([a],"data_summary_".concat(e,".txt"))}),r=await b.beta.assistants.retrieve(A.id),i=r.file_ids||[];console.log("existingFileIds",i),await b.beta.assistants.update(A.id,{file_ids:[...i,n.id]}),r.file_ids=[...i,n.id],console.log("updatedExistingFileIds",(await b.beta.assistants.retrieve(A.id)).file_ids||[])}}}}(),[h,w]=(0,s.useState)([]);(0,s.useEffect)(()=>{w([{message:a.formatMessage({id:"chatGpt.initialMessage",defaultMessage:"Hello, I'm GeoDa.AI powered by ChatGPT! Let's do spatial analysis! Ask me anything about your data."}),sentTime:"just now",sender:"ChatGPT",direction:"incoming",position:"first"}]),t&&f(t)},[]);let[y,T]=(0,s.useState)(!1),E=async e=>{let t=[...h,{message:e,direction:"outgoing",sender:"user",position:"normal"}];w(t),T(!0);let a=await g(e);a&&w([...t,...a]),T(!1)};return(0,i.jsx)(c.ZP,{children:e=>{let{height:t,width:s}=e;return(0,i.jsx)("div",{style:{position:"relative",height:"".concat(t,"px"),width:"".concat(s,"px")},children:(0,i.jsx)(l.tz,{children:(0,i.jsxs)(l.uU,{children:[(0,i.jsx)(l.rN,{autoScrollToBottom:!0,scrollBehavior:"smooth",typingIndicator:y?(0,i.jsx)(l.c2,{content:a.formatMessage({id:"chatGpt.isTyping",defaultMessage:"GeoDa.AI is typing"})}):null,children:h.map((e,t)=>"custom"===e.type?function(e,t){let{functionName:a,functionArgs:s,output:l}=e;return a===r.QUANTILE_BREAKS||a===r.NATURAL_BREAKS||a===r.KNN_WEIGHT||a===r.LOCAL_MORAN?(0,i.jsx)(G,{props:{key:t,functionArgs:s,output:l,dispatch:n,geodaState:p}}):null}(e.payload,t):(0,i.jsx)(l.v0,{model:e},t))}),(0,i.jsx)(l.Ru,{placeholder:a.formatMessage({id:"chatGpt.inputPlaceholder",defaultMessage:"Type message here"}),onSend:E})]})})})}})};var R=()=>{let e=(0,o.Z)(),t=(0,u.v9)(e=>{var t,a;return null===(a=e.root.file)||void 0===a?void 0:null===(t=a.rawFileData)||void 0===t?void 0:t.name}),a=(0,u.v9)(e=>e.root.uiState.openAIKey);return(0,i.jsx)(E.c,{title:e.formatMessage({id:"chatGpt.title",defaultMessage:"GeoDa.AI ChatBot"}),description:e.formatMessage({id:"chatGpt.description",defaultMessage:"Powered by ChatGPT"}),children:a?t?(0,i.jsx)(q,{openAIKey:a}):(0,i.jsx)(T.Xr,{message:"Please load a map first before chatting.",type:"warning"}):(0,i.jsx)(T.Xr,{message:"Please config your OpenAI API key in Settings.",type:"warning"})})}},89687:function(e,t,a){a.d(t,{Zi:function(){return p},bW:function(){return f}});var n=a(2265),r=a(36629),i=a(79121),s=a(37037),l=a(41762);let o={mvp:{mainModule:s,mainWorker:new a.U(a(82471)).toString()},eh:{mainModule:l,mainWorker:new a.U(a(37770)).toString()}},u=null,c=null,d=null;async function m(){if(null===u){await new Promise(e=>setTimeout(e,2e3));let e=await i.Dn(o),t=new Worker(e.mainWorker),a=new i.kw;return u=new i.ak(a,t),await u.instantiate(e.mainModule,e.pthreadWorker),u}return null}async function p(e){if(u&&!d){!c&&e&&(c=e);try{let e=await u.connect(),t=(await e.query('SUMMARIZE "'.concat(c,'"'))).toArray().map(e=>e.toJSON());await e.close();let a=t.map(e=>Object.values(e).join(",")).join("\n"),n=Object.keys(t[0]).join(",");return d="".concat(n,"\n").concat(a)}catch(e){return console.error(e),"error: can not get summary of the table because table name is not found"}}return""}function f(){return{query:(0,n.useCallback)(async e=>{var t;if("SELECT"!==(e=e.trim()).substring(0,6).toUpperCase())throw Error("Only SELECT queries are supported");if(!u)throw Error("DuckDB is not initialized");e="SELECT row_index AS selected_index, ".concat(e.substring(6));let a=await u.connect(),n=null===(t=(await a.query(e)).getChildAt(0))||void 0===t?void 0:t.toArray();return await a.close(),n||[]},[]),importArrowFile:(0,n.useCallback)(async e=>{if(u){let t=await u.connect();if(c=e.name,!(await t.query("select * from information_schema.tables")).toArray().map(e=>e.toJSON()).some(e=>e.table_name===c))try{let a=await e.arrayBuffer(),n=(0,r.p)(a);await t.insertArrowTable(n,{name:c}),await t.query('ALTER TABLE "'.concat(c,'" ADD COLUMN row_index INTEGER DEFAULT 0')),await t.query("CREATE SEQUENCE serial"),await t.query('UPDATE "'.concat(c,"\" SET row_index = nextval('serial') - 1"));let i=await p();console.log("summary",i)}catch(e){console.error(e)}await t.close()}},[])}}setTimeout(async()=>{u=await m()},200)}}]);